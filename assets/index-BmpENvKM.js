var dt=Object.defineProperty;var ft=(m,t,e)=>t in m?dt(m,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):m[t]=e;var ot=(m,t,e)=>ft(m,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();class ut{constructor(t){if(this.canvas=t,this.ctx=t.getContext("2d"),this.width=t.width,this.height=t.height,!this.ctx)throw new Error("No se pudo obtener el contexto 2D del canvas");this.scenes=new Map,this.currentScene=null,this.nextScene=null,this.running=!1,this.lastTime=0,this.transitioning=!1,this.transitionDuration=.3,this.transitionProgress=0}registerScene(t,e){e.sceneManager=this,e.canvas=this.canvas,e.ctx=this.ctx,e.width=this.width,e.height=this.height,this.scenes.set(t,e)}switchTo(t,e={}){const s=this.scenes.get(t);if(!s){console.error(`Escena '${t}' no encontrada`);return}this.currentScene&&this.currentScene.exit(),this.currentScene=s,this.currentScene.enter(e),console.log(`ðŸ“º Cambio a escena: ${t}`)}start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.loop(this.lastTime))}stop(){this.running=!1}pauseLoop(){this.running&&(this.running=!1,console.log("â¸ï¸ SceneManager loop pausado"))}resumeLoop(){this.running||(this.running=!0,this.lastTime=performance.now(),this.loop(this.lastTime),console.log("â–¶ï¸ SceneManager loop reanudado"))}loop(t){if(!this.running)return;const e=(t-this.lastTime)/1e3;this.lastTime=t,this.currentScene&&(this.currentScene.update(e),this.currentScene.render()),requestAnimationFrame(s=>this.loop(s))}getCurrentScene(){return this.currentScene}}class et{constructor(){this.sceneManager=null,this.canvas=null,this.ctx=null,this.width=0,this.height=0}enter(t={}){}exit(){}update(t){}render(){}}class it{constructor(t={}){this.particles=[],this.pool=[],this.maxParticles=t.maxParticles||500,this.enabled=t.enabled!==!1;for(let e=0;e<this.maxParticles;e++)this.pool.push(new pt)}getParticle(){return this.pool.length>0?this.pool.pop():null}releaseParticle(t){t.reset(),this.pool.push(t)}createExplosion(t,e,s={}){if(!this.enabled)return;const a={...{count:15,color:"#ff6600",size:4,speed:100,lifetime:.8,gravity:200},...s};for(let n=0;n<a.count;n++){const o=this.getParticle();if(!o)break;const l=Math.PI*2*n/a.count+(Math.random()-.5)*.5,h=a.speed*(.7+Math.random()*.6);o.init(t,e,Math.cos(l)*h,Math.sin(l)*h,a.size,a.color,a.lifetime,a.gravity),this.particles.push(o)}}createGhostConversion(t,e){if(this.enabled)for(let s=0;s<20;s++){const i=this.getParticle();if(!i)break;const a=Math.random()*Math.PI*2,n=50+Math.random()*100;i.init(t,e,Math.cos(a)*n,Math.sin(a)*n,3+Math.random()*3,s%2===0?"#00ffff":"#00aaff",1.2,-50),this.particles.push(i)}}createTrail(t,e,s="#bd00ff"){if(!this.enabled||this.particles.length>=this.maxParticles)return;const i=this.getParticle();i&&(i.init(t+(Math.random()-.5)*8,e+(Math.random()-.5)*8,(Math.random()-.5)*20,(Math.random()-.5)*20,2+Math.random()*2,s,.4,0),this.particles.push(i))}createImpact(t,e,s,i){if(!this.enabled)return;const a=Math.atan2(i,s),n="#ff6600";for(let o=0;o<8;o++){const l=this.getParticle();if(!l)break;const h=a+Math.PI+(Math.random()-.5)*Math.PI,r=50+Math.random()*100;l.init(t,e,Math.cos(h)*r,Math.sin(h)*r,2+Math.random()*3,n,.5,100),this.particles.push(l)}}update(t){if(this.enabled)for(let e=this.particles.length-1;e>=0;e--){const s=this.particles[e];s.update(t),s.active||(this.particles.splice(e,1),this.releaseParticle(s))}}render(t){for(const e of this.particles)e.render(t)}clear(){for(const t of this.particles)this.releaseParticle(t);this.particles.length=0}getCount(){return this.particles.length}}class pt{constructor(){this.reset()}init(t,e,s,i,a,n,o,l=0){this.x=t,this.y=e,this.vx=s,this.vy=i,this.size=a,this.color=n,this.lifetime=o,this.age=0,this.active=!0,this.gravity=l,this.initialSize=a}reset(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.size=0,this.color="#ffffff",this.lifetime=0,this.age=0,this.active=!1,this.gravity=0,this.initialSize=0}update(t){if(this.age+=t,this.age>=this.lifetime){this.active=!1;return}this.x+=this.vx*t,this.y+=this.vy*t,this.vy+=this.gravity*t;const e=this.age/this.lifetime;this.size=this.initialSize*(1-e)}render(t){const s=1-this.age/this.lifetime,i=this.color.replace("#",""),a=parseInt(i.substr(0,2),16),n=parseInt(i.substr(2,2),16),o=parseInt(i.substr(4,2),16);t.fillStyle=`rgba(${a}, ${n}, ${o}, ${s})`,t.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size)}}class mt extends et{constructor(){super(),this.particleSystem=null,this.playButton={x:0,y:0,width:280,height:70,text:"JUGAR",hovered:!1,scale:1,targetScale:1},this.titlePulse=0,this.particleSpawnTimer=0,this.mouseX=0,this.mouseY=0,this.mouseMoveListener=null,this.mouseClickListener=null}enter(t={}){console.log("ðŸŽ® Entrando al menÃº principal"),this.transitioning=!1,this.particleSystem=new it({maxParticles:200,enabled:!0}),this.playButton.x=this.width/2-this.playButton.width/2,this.playButton.y=this.height/2+80,this.canvasBounds=this.canvas.getBoundingClientRect(),this.cacheGradients(),this.setupMouseListeners(),this.spawnBackgroundParticles(30)}exit(){this.mouseMoveListener&&(this.canvas.removeEventListener("mousemove",this.mouseMoveListener),this.mouseMoveListener=null),this.mouseClickListener&&(this.canvas.removeEventListener("click",this.mouseClickListener),this.mouseClickListener=null),this.particleSystem&&(this.particleSystem.clear(),this.particleSystem=null),this.canvasBounds=null,this.backgroundGradient=null,this.titleGradient=null,this.buttonGradientNormal=null,this.buttonGradientHover=null,console.log("ðŸ‘‹ Saliendo del menÃº principal")}setupMouseListeners(){this.mouseMoveListener=t=>{this.mouseX=t.clientX-this.canvasBounds.left,this.mouseY=t.clientY-this.canvasBounds.top,this.checkButtonHover()},this.mouseClickListener=t=>{const e=t.clientX-this.canvasBounds.left,s=t.clientY-this.canvasBounds.top;this.isPointInButton(e,s)&&this.startGame()},this.canvas.addEventListener("mousemove",this.mouseMoveListener),this.canvas.addEventListener("click",this.mouseClickListener)}checkButtonHover(){const t=this.playButton.hovered;this.playButton.hovered=this.isPointInButton(this.mouseX,this.mouseY),this.playButton.hovered!==t&&(this.playButton.targetScale=this.playButton.hovered?1.1:1,this.playButton.hovered&&this.particleSystem.createExplosion(this.playButton.x+this.playButton.width/2,this.playButton.y+this.playButton.height/2,{count:8,color:"#bd00ff",speed:80,size:3,lifetime:.6}))}isPointInButton(t,e){return t>=this.playButton.x&&t<=this.playButton.x+this.playButton.width&&e>=this.playButton.y&&e<=this.playButton.y+this.playButton.height}startGame(){this.transitioning||(this.transitioning=!0,console.log("ðŸŽ¯ Iniciando partida..."),this.particleSystem.createExplosion(this.playButton.x+this.playButton.width/2,this.playButton.y+this.playButton.height/2,{count:25,color:"#8b00ff",speed:150,size:5,lifetime:.8}),setTimeout(()=>{this.sceneManager.switchTo("game")},200))}spawnBackgroundParticles(t){for(let e=0;e<t;e++){const s=Math.random()*this.width,i=Math.random()*this.height;this.particleSystem.createTrail(s,i,Math.random()>.5?"#8b00ff":"#00ffff")}}update(t){this.titlePulse+=t*2;const e=8;this.playButton.scale+=(this.playButton.targetScale-this.playButton.scale)*e*t,this.particleSystem.update(t),this.particleSpawnTimer+=t,this.particleSpawnTimer>=1&&this.particleSystem.getCount()<150&&(this.spawnBackgroundParticles(1),this.particleSpawnTimer=0)}cacheGradients(){this.backgroundGradient=this.ctx.createLinearGradient(0,0,0,this.height),this.backgroundGradient.addColorStop(0,"#0a0a0a"),this.backgroundGradient.addColorStop(.5,"#1a1a2e"),this.backgroundGradient.addColorStop(1,"#0a0a0a"),this.titleGradient=this.ctx.createLinearGradient(this.width/2-300,0,this.width/2+300,0),this.titleGradient.addColorStop(0,"#bd00ff"),this.titleGradient.addColorStop(.5,"#8b00ff"),this.titleGradient.addColorStop(1,"#bd00ff");const t=this.playButton;this.buttonGradientNormal=this.ctx.createLinearGradient(t.x,t.y,t.x,t.y+t.height),this.buttonGradientNormal.addColorStop(0,"#8b00ff"),this.buttonGradientNormal.addColorStop(1,"#6a00cc"),this.buttonGradientHover=this.ctx.createLinearGradient(t.x,t.y,t.x,t.y+t.height),this.buttonGradientHover.addColorStop(0,"#bd00ff"),this.buttonGradientHover.addColorStop(1,"#8b00ff")}render(){this.ctx.fillStyle=this.backgroundGradient,this.ctx.fillRect(0,0,this.width,this.height),this.particleSystem.render(this.ctx),this.renderTitle(),this.renderSubtitle(),this.renderPlayButton(),this.renderFooter()}renderTitle(){this.ctx.save();const t=1+Math.sin(this.titlePulse)*.2;this.ctx.textAlign="center";for(let e=2;e>0;e--)this.ctx.fillStyle=`rgba(138, 0, 255, ${.3/e})`,this.ctx.font=`bold ${Math.floor(80*t)}px serif`,this.ctx.fillText("NIGROMANTE",this.width/2+e*3,this.height/2-100+e*3);this.ctx.fillStyle=this.titleGradient,this.ctx.font=`bold ${Math.floor(80*t)}px serif`,this.ctx.fillText("NIGROMANTE",this.width/2,this.height/2-100),this.ctx.strokeStyle="#00ffff",this.ctx.lineWidth=2,this.ctx.strokeText("NIGROMANTE",this.width/2,this.height/2-100),this.ctx.restore()}renderSubtitle(){this.ctx.save(),this.ctx.textAlign="center",this.ctx.fillStyle="#aaaaaa",this.ctx.font="24px serif",this.ctx.fillText("El Invocador de las Sombras",this.width/2,this.height/2-30),this.ctx.restore()}renderPlayButton(){this.ctx.save();const t=this.playButton,e=t.x+t.width/2,s=t.y+t.height/2;this.ctx.translate(e,s),this.ctx.scale(t.scale,t.scale),this.ctx.translate(-e,-s),t.hovered&&(this.ctx.shadowBlur=30,this.ctx.shadowColor="#bd00ff");const i=t.hovered?this.buttonGradientHover:this.buttonGradientNormal;this.roundRect(t.x,t.y,t.width,t.height,10,!0,!0),this.ctx.fillStyle=i,this.ctx.fill(),this.ctx.strokeStyle=t.hovered?"#ff00ff":"#bd00ff",this.ctx.lineWidth=t.hovered?3:2,this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.fillStyle="#ffffff",this.ctx.font="bold 32px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.text,e,s),this.ctx.restore()}renderFooter(){this.ctx.save(),this.ctx.textAlign="center",this.ctx.fillStyle="#666666",this.ctx.font="16px Arial",this.ctx.fillText("Controles: WASD - Movimiento | ESPACIO - Atacar",this.width/2,this.height-50),this.ctx.fillStyle="#444444",this.ctx.font="14px Arial",this.ctx.fillText("Â© 2026 Nigromante Game - Desarrollado con Vite + Canvas",this.width/2,this.height-20),this.ctx.restore()}roundRect(t,e,s,i,a,n,o){this.ctx.beginPath(),this.ctx.moveTo(t+a,e),this.ctx.lineTo(t+s-a,e),this.ctx.quadraticCurveTo(t+s,e,t+s,e+a),this.ctx.lineTo(t+s,e+i-a),this.ctx.quadraticCurveTo(t+s,e+i,t+s-a,e+i),this.ctx.lineTo(t+a,e+i),this.ctx.quadraticCurveTo(t,e+i,t,e+i-a),this.ctx.lineTo(t,e+a),this.ctx.quadraticCurveTo(t,e,t+a,e),this.ctx.closePath()}}class K{constructor(t,e,s,i){this.x=t,this.y=e,this.width=s,this.height=i,this.vx=0,this.vy=0,this.active=!0}update(t){}render(t){}getBounds(){return{left:this.x,right:this.x+this.width,top:this.y,bottom:this.y+this.height}}collidesWith(t){if(!t||!t.getBounds)return!1;const e=this.getBounds(),s=t.getBounds();return!(e.right<s.left||e.left>s.right||e.bottom<s.top||e.top>s.bottom)}constrainToBounds(t,e){this.x<5&&(this.x=5,this.vx=Math.max(0,this.vx)),this.x+this.width>t-5&&(this.x=t-this.width-5,this.vx=Math.min(0,this.vx)),this.y<5&&(this.y=5,this.vy=Math.max(0,this.vy)),this.y+this.height>e-5&&(this.y=e-this.height-5,this.vy=Math.min(0,this.vy))}}const S=class S{static shadeColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.floor(255*e),a=Math.max(0,(s>>16)-i),n=Math.max(0,(s>>8&255)-i),o=Math.max(0,(s&255)-i);return"#"+(16777216+a*65536+n*256+o).toString(16).slice(1)}static lightenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.floor(255*e),a=Math.min(255,(s>>16)+i),n=Math.min(255,(s>>8&255)+i),o=Math.min(255,(s&255)+i);return"#"+(16777216+a*65536+n*256+o).toString(16).slice(1)}static renderNigromante(t,e,s,i,a,n=0,o=null){if(!t||i<=0||a<=0)return;n=Number(n)||0,t.save();const l=e+i/2,h=s+a/2,r=i*1.5,c=t.createRadialGradient(l,h,0,l,h,r);c.addColorStop(0,"rgba(138, 0, 255, 0.3)"),c.addColorStop(.5,"rgba(75, 0, 130, 0.2)"),c.addColorStop(1,"transparent"),t.fillStyle=c,t.beginPath(),t.arc(l,h,r,0,Math.PI*2),t.fill();const d=Math.sin(n*2)*3;for(let G=0;G<4;G++){const X=G*Math.PI/2+n*.5,J=l+Math.cos(X)*(i*.7),Q=h+Math.sin(X)*(i*.7)+d,Z=2+Math.sin(n*3+G)*1;t.fillStyle="rgba(138, 0, 255, 0.8)",t.beginPath(),t.arc(J,Q,Z,0,Math.PI*2),t.fill()}t.fillStyle="rgba(0, 0, 0, 0.4)",t.beginPath(),t.ellipse(l,s+a,i*.4,a*.15,0,0,Math.PI*2),t.fill();const u=t.createLinearGradient(e,s,e,s+a);u.addColorStop(0,"#1a0033"),u.addColorStop(.5,"#0d001a"),u.addColorStop(1,"#000000"),t.fillStyle=u,t.beginPath(),t.moveTo(e+i*.3,s),t.lineTo(e+i*.7,s),t.quadraticCurveTo(e+i,s+a*.3,e+i,s+a),t.lineTo(e,s+a),t.quadraticCurveTo(e,s+a*.3,e+i*.3,s),t.fill(),t.strokeStyle="#4a0080",t.lineWidth=1,t.stroke(),t.fillStyle="#0a0014",t.beginPath(),t.ellipse(l,s+a*.25,i*.35,a*.25,0,0,Math.PI*2),t.fill(),t.fillStyle="#000000",t.beginPath(),t.ellipse(l,s+a*.27,i*.25,a*.18,0,0,Math.PI),t.fill();const f=s+a*.25,M=4+Math.sin(n*4)*1;t.shadowBlur=M,t.shadowColor="#00ffff",t.fillStyle="#00ffff",t.beginPath(),t.arc(l-i*.15,f,i*.08,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(l+i*.15,f,i*.08,0,Math.PI*2),t.fill(),t.shadowBlur=0;const p=e+i*.9,C=s+a*.1,E=s+a*.95;t.strokeStyle="#3d2814",t.lineWidth=i*.08,t.lineCap="round",t.beginPath(),t.moveTo(p,C+a*.15),t.lineTo(p,E),t.stroke();const R=i*.15,Y=1+Math.sin(n*3)*.2,H=t.createRadialGradient(p,C,0,p,C,R*Y*2);H.addColorStop(0,"rgba(138, 0, 255, 0.8)"),H.addColorStop(.5,"rgba(138, 0, 255, 0.4)"),H.addColorStop(1,"transparent"),t.fillStyle=H,t.beginPath(),t.arc(p,C,R*Y*2,0,Math.PI*2),t.fill(),t.fillStyle="#8a00ff",t.beginPath(),t.arc(p,C,R*Y,0,Math.PI*2),t.fill(),t.fillStyle="#bd00ff",t.beginPath(),t.arc(p-R*.3,C-R*.3,R*.4,0,Math.PI*2),t.fill(),t.restore()}static renderOrc(t,e,s,i,a,n=0,o=!1,l=null,h="warrior"){if(e=Number(e)||0,s=Number(s)||0,i=Number(i)||0,a=Number(a)||0,n=Number(n)||0,!t||!isFinite(e)||!isFinite(s)||!isFinite(i)||!isFinite(a)||i<=0||a<=0)return;o=!!o,t.save();const r=e+i/2,c=s+a/2;if(o){t.globalAlpha=.85;const g=.9+Math.sin(n*4)*.05;t.globalAlpha*=g}if(!o){t.fillStyle="rgba(0, 0, 0, 0.3)",t.beginPath(),t.ellipse(r,s+a,i*.35,a*.12,0,0,Math.PI*2),t.fill();const g=t.globalCompositeOperation;t.globalCompositeOperation="multiply";const y=t.createRadialGradient(r,s+a*.95,0,r,s+a*.95,i*.5);y.addColorStop(0,"rgba(0, 0, 0, 0.4)"),y.addColorStop(1,"transparent"),t.fillStyle=y,t.beginPath(),t.ellipse(r,s+a*.95,i*.4,a*.15,0,0,Math.PI*2),t.fill(),t.globalCompositeOperation=g}let d,u,f;if(o)d="#0099ff",u=S.shadeColor(d,.4),f=S.lightenColor(d,.3);else switch(h){case"tank":d="#1a3d0f",u=S.shadeColor(d,.5),f=S.lightenColor(d,.25);break;case"shaman":d="#4a6b35",u=S.shadeColor(d,.45),f=S.lightenColor(d,.28);break;case"assassin":d="#6b7a5c",u=S.shadeColor(d,.4),f=S.lightenColor(d,.22);break;default:d="#4a7832",u=S.shadeColor(d,.42),f=S.lightenColor(d,.25)}const M=e+i*.15,p=s+a*.35,C=i*.7,E=a*.55,R=t.createLinearGradient(M,p,M+C,p);R.addColorStop(0,f),R.addColorStop(.5,d),R.addColorStop(1,u),t.fillStyle=R,t.fillRect(M,p,C,E),t.strokeStyle="#1a1a1a",t.lineWidth=2,t.strokeRect(M,p,C,E),t.strokeStyle=o?"rgba(0, 200, 255, 0.5)":"rgba(0, 0, 0, 0.3)",t.lineWidth=2,t.beginPath(),t.moveTo(r,s+a*.4),t.lineTo(r,s+a*.8),t.stroke();const Y=o?"#0066cc":d,H=S.shadeColor(Y,.35),G=S.lightenColor(Y,.2),X=t.createRadialGradient(r,s+a*.2,0,r,s+a*.2,i*.35);X.addColorStop(0,G),X.addColorStop(.6,Y),X.addColorStop(1,H),t.fillStyle=X,t.beginPath(),t.ellipse(r,s+a*.22,i*.35,a*.25,0,0,Math.PI*2),t.fill(),t.strokeStyle="#1a1a1a",t.lineWidth=2,t.beginPath(),t.ellipse(r,s+a*.22,i*.35,a*.25,0,0,Math.PI*2),t.stroke(),t.fillStyle=o?"#0099ff":u,t.beginPath(),t.moveTo(r-i*.25,s+a*.3),t.quadraticCurveTo(r,s+a*.4,r+i*.25,s+a*.3),t.quadraticCurveTo(r+i*.15,s+a*.35,r,s+a*.37),t.quadraticCurveTo(r-i*.15,s+a*.35,r-i*.25,s+a*.3),t.fill(),t.fillStyle=o?"#aaffff":"#ffffff",t.beginPath(),t.moveTo(r-i*.1,s+a*.32),t.lineTo(r-i*.08,s+a*.38),t.lineTo(r-i*.12,s+a*.38),t.fill(),t.beginPath(),t.moveTo(r+i*.1,s+a*.32),t.lineTo(r+i*.08,s+a*.38),t.lineTo(r+i*.12,s+a*.38),t.fill();const J=o?"#ffffff":"#ffff00",Q=o?"#ff00ff":"#ff0000",Z=.5+Math.sin(n*6)*.4,D=Math.min(1,Z),O=i*.15,_=t.createRadialGradient(r-i*.15,s+a*.21,0,r-i*.15,s+a*.21,O);_.addColorStop(0,`rgba(${o?"0, 255, 255":"255, 255, 0"}, ${D})`),_.addColorStop(.5,`rgba(${o?"0, 255, 255":"255, 255, 0"}, ${D*.4})`),_.addColorStop(1,"transparent"),t.fillStyle=_,t.beginPath(),t.arc(r-i*.15,s+a*.21,O,0,Math.PI*2),t.fill();const z=t.createRadialGradient(r+i*.125,s+a*.21,0,r+i*.125,s+a*.21,O);if(z.addColorStop(0,`rgba(${o?"0, 255, 255":"255, 255, 0"}, ${D})`),z.addColorStop(.5,`rgba(${o?"0, 255, 255":"255, 255, 0"}, ${D*.4})`),z.addColorStop(1,"transparent"),t.fillStyle=z,t.beginPath(),t.arc(r+i*.125,s+a*.21,O,0,Math.PI*2),t.fill(),t.fillStyle=J,t.fillRect(r-i*.2,s+a*.15,i*.15,a*.12),t.fillRect(r+i*.05,s+a*.15,i*.15,a*.12),t.strokeStyle="#1a1a1a",t.lineWidth=1,t.strokeRect(r-i*.2,s+a*.15,i*.15,a*.12),t.strokeRect(r+i*.05,s+a*.15,i*.15,a*.12),t.fillStyle=Q,t.fillRect(r-i*.15,s+a*.17,i*.08,a*.08),t.fillRect(r+i*.1,s+a*.17,i*.08,a*.08),t.shadowBlur=0,h==="shaman"){const g=o?"rgba(100, 120, 140, 0.5)":"#5d4332",y=o?"rgba(130, 110, 90, 0.6)":"#8b6c47";t.fillStyle=g,t.fillRect(e+i*.15,s+a*.35,i*.7,a*.6),t.fillStyle=y,t.beginPath(),t.arc(e+i*.2,s+a*.42,i*.15,0,Math.PI),t.fill(),t.beginPath(),t.arc(e+i*.8,s+a*.42,i*.15,0,Math.PI),t.fill(),t.fillStyle=g,t.beginPath(),t.arc(r,s+a*.18,i*.45,0,Math.PI),t.fill();const v=o?"rgba(255, 255, 200, 0.8)":"#e8d5a0";t.fillStyle=v;for(let T=0;T<5;T++)t.beginPath(),t.arc(e+i*(.25+T*.1),s+a*.48,i*.04,0,Math.PI*2),t.fill();t.strokeStyle=o?"rgba(255, 100, 255, 0.9)":"#ff3333",t.lineWidth=3,t.beginPath(),t.arc(r,s+a*.58,i*.08,0,Math.PI*2),t.stroke(),t.lineWidth=1.5,t.beginPath(),t.moveTo(r-i*.05,s+a*.55),t.lineTo(r+i*.05,s+a*.61),t.moveTo(r+i*.05,s+a*.55),t.lineTo(r-i*.05,s+a*.61),t.stroke()}else if(h==="tank"){const g="#4a4a4a",y=S.lightenColor(g,.35),v=g,T=S.lightenColor(g,.2),w=S.shadeColor(g,.5),P=S.shadeColor(g,.7),W=t.createRadialGradient(e+i*.05,s+a*.3,0,e+i*.05,s+a*.3,i*.22);W.addColorStop(0,y),W.addColorStop(.5,v),W.addColorStop(1,w),t.fillStyle=W,t.beginPath(),t.arc(e+i*.05,s+a*.35,i*.22,0,Math.PI*2),t.fill(),t.strokeStyle="#1a1a1a",t.lineWidth=2,t.stroke();const j=t.createRadialGradient(e+i*.95,s+a*.3,0,e+i*.95,s+a*.3,i*.22);j.addColorStop(0,y),j.addColorStop(.5,v),j.addColorStop(1,w),t.fillStyle=j,t.beginPath(),t.arc(e+i*.95,s+a*.35,i*.22,0,Math.PI*2),t.fill(),t.stroke(),t.fillStyle=P;for(let B=0;B<6;B++){const k=B*Math.PI/3;t.beginPath(),t.moveTo(e+i*.05,s+a*.35),t.lineTo(e+i*.05+Math.cos(k)*i*.15,s+a*.35+Math.sin(k)*i*.08),t.lineWidth=i*.02,t.stroke(),t.beginPath(),t.moveTo(e+i*.95,s+a*.35),t.lineTo(e+i*.95+Math.cos(k)*i*.15,s+a*.35+Math.sin(k)*i*.08),t.stroke()}const I=e+i*.1,L=s+a*.4,b=i*.8,nt=a*.5,N=t.createLinearGradient(I,L,I+b,L);N.addColorStop(0,y),N.addColorStop(.25,v),N.addColorStop(.5,g),N.addColorStop(.75,v),N.addColorStop(1,w),t.fillStyle=N,t.fillRect(I,L,b,nt),t.strokeStyle="#1a1a1a",t.lineWidth=2,t.strokeRect(I,L,b,nt);const F=t.createLinearGradient(e+i*.15,s+a*.42,e+i*.85,s+a*.42);F.addColorStop(0,y),F.addColorStop(.5,T),F.addColorStop(1,v),t.fillStyle=F,t.fillRect(e+i*.15,s+a*.42,i*.7,a*.15),t.strokeStyle="#1a1a1a",t.lineWidth=1,t.strokeRect(e+i*.15,s+a*.42,i*.7,a*.15);const U=t.createLinearGradient(e+i*.12,s+a*.58,e+i*.88,s+a*.58);U.addColorStop(0,v),U.addColorStop(.5,g),U.addColorStop(1,w),t.fillStyle=U,t.fillRect(e+i*.12,s+a*.58,i*.76,a*.15),t.strokeRect(e+i*.12,s+a*.58,i*.76,a*.15);const V=i*.06;[[.2,.45],[.35,.45],[.5,.45],[.65,.45],[.8,.45],[.18,.62],[.32,.62],[.5,.62],[.68,.62],[.82,.62],[.25,.78],[.4,.78],[.6,.78],[.75,.78]].forEach(([B,k])=>{const A=t.createRadialGradient(e+i*B-V*.3,s+a*k-V*.3,0,e+i*B,s+a*k,V);A.addColorStop(0,T),A.addColorStop(.3,v),A.addColorStop(1,P),t.fillStyle=A,t.beginPath(),t.arc(e+i*B,s+a*k,V,0,Math.PI*2),t.fill(),t.strokeStyle="#1a1a1a",t.lineWidth=1,t.stroke()}),t.strokeStyle="rgba(255, 255, 255, 0.15)",t.lineWidth=1;for(let B=0;B<8;B++){const k=e+i*(.15+Math.random()*.7),A=s+a*(.4+Math.random()*.5),x=k+(Math.random()-.5)*i*.15,tt=A+(Math.random()-.5)*a*.1;t.beginPath(),t.moveTo(k,A),t.lineTo(x,tt),t.stroke()}t.strokeStyle="rgba(0, 0, 0, 0.15)",t.lineWidth=.5;for(let B=0;B<5;B++){const k=e+i*(.15+Math.random()*.7),A=s+a*(.4+Math.random()*.5),x=k+(Math.random()-.5)*i*.1,tt=A+(Math.random()-.5)*a*.08;t.beginPath(),t.moveTo(k,A),t.lineTo(x,tt),t.stroke()}}else if(h==="assassin"){const g=o?"rgba(40, 40, 50, 0.7)":"#1a1a1a",y=o?"rgba(60, 50, 40, 0.6)":"#2d1f14";t.fillStyle=g,t.beginPath(),t.moveTo(e+i*.1,s+a*.25),t.quadraticCurveTo(r-i*.1,s+a*.1,r+i*.3,s+a*.2),t.quadraticCurveTo(e+i*.85,s+a*.35,e+i*.8,s+a*.9),t.quadraticCurveTo(r,s+a*.95,e+i*.2,s+a*.85),t.quadraticCurveTo(e+i*.05,s+a*.6,e+i*.1,s+a*.25),t.fill(),t.fillStyle=y,t.fillRect(e+i*.25,s+a*.45,i*.5,a*.35),t.fillStyle=y,t.fillRect(e+i*.15,s+i*.65,i*.7,a*.08),t.fillStyle=g;for(let v=0;v<4;v++)t.fillRect(e+i*(.2+v*.15),s+a*.68,i*.08,a*.12);t.fillStyle=o?"rgba(80, 80, 90, 0.6)":"#3a3a3a",t.fillRect(e+i*.05,s+a*.5,i*.15,a*.12),t.fillRect(e+i*.8,s+a*.5,i*.15,a*.12)}else{const g=o?"rgba(100, 150, 200, 0.5)":"#5a3d2b";t.fillStyle=g,t.beginPath(),t.arc(e+i*.15,s+a*.4,i*.12,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(e+i*.85,s+a*.4,i*.12,0,Math.PI*2),t.fill(),t.fillRect(e+i*.2,s+a*.4,i*.6,a*.35),t.fillStyle=o?"rgba(200, 220, 255, 0.7)":"#3d2814";for(let y=0;y<3;y++)for(let v=0;v<2;v++)t.beginPath(),t.arc(e+i*(.3+y*.2),s+a*(.45+v*.15),i*.03,0,Math.PI*2),t.fill()}const ht=o?"rgba(150, 200, 255, 0.6)":"#6b4423",ct=o?"rgba(180, 220, 255, 0.7)":"#8c8c8c";if(h==="shaman"){const g=o?"rgba(100, 80, 60, 0.6)":"#4a3020",y=o?"rgba(255, 100, 255, 0.9)":"#ff3333",v=o?"rgba(255, 100, 255, 0.7)":"rgba(255, 51, 51, 0.7)",T=o?"rgba(255, 100, 255, 0.5)":"rgba(255, 51, 51, 0.5)",w=o?"rgba(255, 100, 255, 0)":"rgba(255, 51, 51, 0)",P=o?"rgba(255, 255, 200, 0.8)":"#e8d5a0";t.strokeStyle=g,t.lineWidth=i*.06,t.lineCap="round",t.beginPath(),t.moveTo(e+i*.95,s+a*.25),t.lineTo(e+i*.95,s+a*1.1),t.stroke(),t.strokeStyle=o?"rgba(70, 50, 40, 0.7)":"#2a1a10",t.lineWidth=i*.02;for(let b=0;b<8;b++)t.beginPath(),t.moveTo(e+i*.92,s+a*(.3+b*.09)),t.lineTo(e+i*.98,s+a*(.3+b*.09)),t.stroke();t.fillStyle=P,t.beginPath(),t.ellipse(e+i*.95,s+a*.2,i*.07,i*.08,0,0,Math.PI*2),t.fill(),t.fillStyle=o?"rgba(255, 50, 100, 0.8)":"#aa0000",t.beginPath(),t.arc(e+i*.92,s+a*.18,i*.02,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(e+i*.98,s+a*.18,i*.02,0,Math.PI*2),t.fill();const W=i*.08,j=W*2.5,I=1+Math.sin(n*3.5)*.15,L=t.createRadialGradient(e+i*.95,s+a*.12,0,e+i*.95,s+a*.12,j*I);L.addColorStop(0,v),L.addColorStop(.3,T),L.addColorStop(1,w),t.fillStyle=L,t.beginPath(),t.arc(e+i*.95,s+a*.12,j*I,0,Math.PI*2),t.fill(),t.fillStyle=y,t.beginPath(),t.arc(e+i*.95,s+a*.12,W*I,0,Math.PI*2),t.fill();for(let b=0;b<3;b++)t.fillStyle=`rgba(255, ${50+b*20}, ${100-b*30}, ${.6-b*.1})`,t.beginPath(),t.arc(e+i*(.93+Math.sin(n*2+b)*.03),s+a*(.08+b*.03),i*(.03-b*.008),0,Math.PI*2),t.fill()}else if(h==="tank"){const g=o?"rgba(80, 80, 90, 0.7)":"#3a3a3a",y=o?"rgba(100, 80, 60, 0.6)":"#5a3d2b",v=o?"rgba(120, 120, 140, 0.7)":"#606060";t.strokeStyle=y,t.lineWidth=i*.08,t.lineCap="round",t.beginPath(),t.moveTo(e+i*.98,s+a*.2),t.lineTo(e+i*.98,s+a*1),t.stroke(),t.strokeStyle=o?"rgba(60, 40, 30, 0.7)":"#2a1a10",t.lineWidth=i*.03;for(let P=0;P<5;P++)t.beginPath(),t.arc(e+i*.98,s+a*(.35+P*.12),i*.04,0,Math.PI*2),t.stroke();t.fillStyle=g;const T=i*.25,w=i*.18;t.fillRect(e+i*.85-T/2,s+a*.15-w/2,T,w),t.fillStyle=v,t.fillRect(e+i*.85-T/2+2,s+a*.15-w/2+2,T-4,w/3),t.fillStyle=g;for(let P=0;P<7;P++)t.beginPath(),t.moveTo(e+i*(.72+P*.04),s+a*.06),t.lineTo(e+i*(.73+P*.04),s+a*.11),t.lineTo(e+i*(.74+P*.04),s+a*.06),t.fill()}else if(h==="assassin"){const g=o?"rgba(180, 220, 255, 0.7)":"#aaaaaa",y=o?"rgba(40, 30, 20, 0.7)":"#1a1010",v=o?"rgba(80, 60, 40, 0.6)":"#3a2416";t.strokeStyle=y,t.lineWidth=i*.04,t.lineCap="round",t.beginPath(),t.moveTo(e-i*.05,s+a*.6),t.lineTo(e-i*.05,s+a*.75),t.stroke(),t.fillStyle=g,t.beginPath(),t.moveTo(e-i*.1,s+a*.5),t.lineTo(e-i*.05,s+a*.6),t.lineTo(e,s+a*.55),t.fill(),t.strokeStyle=y,t.lineWidth=i*.04,t.beginPath(),t.moveTo(e+i*1.05,s+a*.6),t.lineTo(e+i*1.05,s+a*.75),t.stroke(),t.fillStyle=g,t.beginPath(),t.moveTo(e+i*1.1,s+a*.5),t.lineTo(e+i*1.05,s+a*.6),t.lineTo(e+i,s+a*.55),t.fill(),t.fillStyle=v,t.fillRect(e+i*.91,s+a*.45,i*.06,i*.02),t.fillRect(e+i*.91,s+a*.55,i*.06,i*.02),o||(t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=1,t.beginPath(),t.moveTo(e+i*.02,s+a*.27),t.lineTo(e+i*-.02,s+a*.3),t.moveTo(e+i*.98,s+a*.27),t.lineTo(e+i*1.02,s+a*.3),t.stroke())}else t.strokeStyle=ht,t.lineWidth=i*.08,t.lineCap="round",t.beginPath(),t.moveTo(e+i*.05,s+a*.5),t.lineTo(e+i*.05,s+a*.95),t.stroke(),t.fillStyle=ct,t.beginPath(),t.moveTo(e-i*.05,s+a*.45),t.lineTo(e+i*.15,s+a*.35),t.lineTo(e+i*.15,s+a*.55),t.fill(),t.strokeStyle=o?"#bbddff":"#aaaaaa",t.lineWidth=1,t.stroke();if(o){t.globalAlpha=.3;const g=t.createRadialGradient(r,c,0,r,c,i*1.2);g.addColorStop(0,"rgba(0, 255, 255, 0.4)"),g.addColorStop(.5,"rgba(102, 0, 255, 0.3)"),g.addColorStop(1,"transparent"),t.fillStyle=g,t.beginPath(),t.arc(r,c,i*1.2,0,Math.PI*2),t.fill();for(let y=0;y<2;y++){const v=Math.sin(n*4+y*Math.PI)*3;t.strokeStyle=`rgba(0, 255, 255, ${.3-y*.1})`,t.lineWidth=2,t.strokeRect(e+v,s,i,a)}}t.restore()}};ot(S,"LIGHT_DIR",{x:-.6,y:-1});let q=S;class gt extends K{constructor(t,e){super(t,e,32,32),this.maxHealth=100,this.health=this.maxHealth,this.damage=6,this.baseArmyCapacity=1,this.armyCapacity=this.baseArmyCapacity,this.maxArmy=this.armyCapacity,this.points=0,this.level=1,this.xp=0,this.experience=0,this.xpToNextLevel=100,this.experienceToNextLevel=100,this.hasHealingUnlocked=!1,this.healingAuraBonus=0,this.healthRegen=0,this.pointsMultiplier=1,this.attackSpeed=.6,this.speed=100,this.inputX=0,this.inputY=0,this.appliedCards=new Set,this.color="#8b00ff",this.glowColor="#bd00ff",this._spriteCache={},this._lastGradientX=-1,this._lastGradientY=-1,this.eventBus=null}updateArmyCapacity(){this.armyCapacity=this.baseArmyCapacity+Math.floor(this.points*1.5),this.maxArmy=this.armyCapacity}setInput(t,e){this.inputX=t,this.inputY=e}update(t){this.healthRegen>0&&(this.health=Math.min(this.maxHealth,this.health+this.healthRegen*t)),this.hasHealingUnlocked?(this.healingAuraRadius=150+(this.healingAuraBonus||0),this.healingPower=5+this.maxHealth*.05):this.healingAuraRadius=0;const e=Math.sqrt(this.inputX*this.inputX+this.inputY*this.inputY);if(e>0){const s=this.inputX/e,i=this.inputY/e;this.vx=s*this.speed,this.vy=i*this.speed}else this.vx=0,this.vy=0;this.x+=this.vx*t,this.y+=this.vy*t}render(t,e=null){const s=e!==null?e:performance.now()/1e3;this.renderHealingAura(t,s),q.renderNigromante(t,this.x,this.y,this.width,this.height,s,this._spriteCache),this.renderHealthBar(t)}renderHealthBar(t){const e=this.width,s=4,i=this.x,a=this.y-10;t.fillStyle="#333",t.fillRect(i,a,e,s);const n=this.maxHealth>0?this.health/this.maxHealth:0;t.fillStyle=n>.5?"#00ff00":n>.25?"#ffaa00":"#ff0000",t.fillRect(i,a,e*n,s)}renderHealingAura(t,e){if(!this.hasHealingUnlocked||!this.healingAuraRadius)return;const s=this.x+this.width/2,i=this.y+this.height/2;t.save();const a=.7+Math.sin(e*3)*.3,n=this.healingAuraRadius*a,o=t.createRadialGradient(s,i,0,s,i,n);o.addColorStop(0,"rgba(138, 43, 226, 0.4)"),o.addColorStop(.7,"rgba(75, 0, 130, 0.2)"),o.addColorStop(1,"rgba(75, 0, 130, 0.05)"),t.fillStyle=o,t.beginPath(),t.arc(s,i,n,0,Math.PI*2),t.fill(),t.strokeStyle=`rgba(138, 43, 226, ${.3*a})`,t.lineWidth=2,t.beginPath(),t.arc(s,i,n,0,Math.PI*2),t.stroke(),t.restore()}applyHealingAura(t,e){if(!this.hasHealingUnlocked||!this.healingAuraRadius||!this.healingPower)return;const s=this.x+this.width/2,i=this.y+this.height/2,a=this.healingAuraRadius*this.healingAuraRadius;for(const n of t){if(!n.active||n.health>=n.maxHealth)continue;const o=n.x+n.width/2,l=n.y+n.height/2;if((o-s)**2+(l-i)**2<=a){const r=this.healingPower*e;n.heal(r)}}}takeDamage(t){this.health-=t,this.health<=0&&(this.health=0,this.active=!1)}heal(t){this.health=Math.min(this.maxHealth,this.health+t)}addExperience(t){const e=t*(this.pointsMultiplier||1);for(this.experience+=e,this.xp=this.experience;this.experience>=this.experienceToNextLevel;)this.levelUp()}levelUp(){this.level++,this.experience=Math.max(0,this.experience-this.experienceToNextLevel),this.experienceToNextLevel=Math.floor(this.experienceToNextLevel*1.5),this.xp=this.experience,this.xpToNextLevel=this.experienceToNextLevel,this.experienceToNextLevel===0&&(this.experienceToNextLevel=100,this.xpToNextLevel=100),this.eventBus&&this.eventBus.emit("player_level_up",{level:this.level,player:this}),console.log(`Â¡Nivel ${this.level} alcanzado!`)}}class yt{constructor(t){this.canvas=t,this.isMobile=this.checkMobile();const e=this.isMobile?1.5:1;this.baseRadius=50*e,this.stickRadius=30*e,this.baseX=this.baseRadius+20,this.baseY=t.height-this.baseRadius-20,this.isPressed=!1,this.touchX=this.baseX,this.touchY=this.baseY,this.directionX=0,this.directionY=0,this.setupEventListeners()}checkMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}setupEventListeners(){this.canvas.addEventListener("touchstart",t=>this.handleTouchStart(t)),this.canvas.addEventListener("touchmove",t=>this.handleTouchMove(t)),this.canvas.addEventListener("touchend",t=>this.handleTouchEnd(t))}handleTouchStart(t){const e=t.touches[0],s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,a=e.clientY-s.top,n=i-this.baseX,o=a-this.baseY;Math.sqrt(n*n+o*o)<this.baseRadius*1.5&&(this.isPressed=!0,this.updateJoystickPosition(i,a))}handleTouchMove(t){if(!this.isPressed)return;const e=t.touches[0],s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,a=e.clientY-s.top;this.updateJoystickPosition(i,a)}handleTouchEnd(t){this.isPressed=!1,this.touchX=this.baseX,this.touchY=this.baseY,this.directionX=0,this.directionY=0}updateJoystickPosition(t,e){const s=t-this.baseX,i=e-this.baseY,a=Math.sqrt(s*s+i*i);if(a>this.baseRadius){const n=Math.atan2(i,s);this.touchX=this.baseX+Math.cos(n)*this.baseRadius,this.touchY=this.baseY+Math.sin(n)*this.baseRadius,this.directionX=Math.cos(n),this.directionY=Math.sin(n)}else this.touchX=t,this.touchY=e,a>0?(this.directionX=s/a,this.directionY=i/a):(this.directionX=0,this.directionY=0)}render(t){this.isMobile&&(t.fillStyle="rgba(100, 100, 100, 0.3)",t.beginPath(),t.arc(this.baseX,this.baseY,this.baseRadius,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(200, 200, 200, 0.5)",t.lineWidth=2,t.stroke(),t.fillStyle=this.isPressed?"rgba(0, 150, 255, 0.6)":"rgba(100, 150, 200, 0.5)",t.beginPath(),t.arc(this.touchX,this.touchY,this.stickRadius,0,Math.PI*2),t.fill(),t.strokeStyle=this.isPressed?"rgba(0, 200, 255, 0.8)":"rgba(150, 200, 255, 0.6)",t.lineWidth=2,t.stroke(),this.isPressed&&(this.directionX!==0||this.directionY!==0)&&(t.strokeStyle="rgba(0, 200, 255, 0.7)",t.lineWidth=1,t.beginPath(),t.moveTo(this.baseX,this.baseY),t.lineTo(this.baseX+this.directionX*this.baseRadius,this.baseY+this.directionY*this.baseRadius),t.stroke()))}getDirection(){return{x:this.directionX,y:this.directionY}}isActive(){return this.isPressed&&(this.directionX!==0||this.directionY!==0)}}class vt{constructor(t=null){this.keys=new Set,this.canvas=t,this.virtualJoystick=t?new yt(t):null,this.handleKeyDown=e=>{e.key&&this.keys.add(e.key.toLowerCase())},this.handleKeyUp=e=>{e.key&&this.keys.delete(e.key.toLowerCase())},window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}isKeyPressed(t){return this.keys.has(t.toLowerCase())}getMovementInput(){let t=0,e=0;if((this.isKeyPressed("w")||this.isKeyPressed("arrowup"))&&(e-=1),(this.isKeyPressed("s")||this.isKeyPressed("arrowdown"))&&(e+=1),(this.isKeyPressed("a")||this.isKeyPressed("arrowleft"))&&(t-=1),(this.isKeyPressed("d")||this.isKeyPressed("arrowright"))&&(t+=1),this.virtualJoystick){const i=this.virtualJoystick.getDirection();t+=i.x,e+=i.y}const s=Math.sqrt(t*t+e*e);return s>1&&(t/=s,e/=s),{x:t,y:e}}isAttackPressed(){return this.isKeyPressed(" ")||this.isKeyPressed("enter")}getVirtualJoystick(){return this.virtualJoystick}destroy(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),this.keys.clear()}}class St{constructor(){this.entities=new Map}register(t,e){this.entities.set(t,e)}get(t){return this.entities.get(t)||[]}update(t,e,...s){const i=this.get(t);for(let a=i.length-1;a>=0;a--){const n=i[a];n.update(e,...s),n.active||i.splice(a,1)}}updateAll(t,...e){for(const[s,i]of this.entities)this.update(s,t,...e)}render(t,e,s=0){this.get(t).forEach(a=>a.render(e,s))}renderAll(t,e=[],s=0){if(e.length===0)for(const[i,a]of this.entities)this.render(i,t,s);else e.forEach(i=>this.render(i,t,s))}clear(t){const e=this.get(t);e.length=0}clearAll(){for(const[t,e]of this.entities)e.length=0}count(t){return this.get(t).length}getAllEntities(){const t=[];for(const[e,s]of this.entities)t.push(...s);return t}}class Ct{constructor(t,e,s){this.ctx=t,this.width=e,this.height=s,this.gridCanvas=null,this.showGrid=!1,this.gridSize=40}initGrid(){this.gridCanvas=document.createElement("canvas"),this.gridCanvas.width=this.width,this.gridCanvas.height=this.height;const t=this.gridCanvas.getContext("2d");t.strokeStyle="#1a1a1a",t.lineWidth=1,t.beginPath();for(let e=0;e<this.width;e+=this.gridSize)t.moveTo(e,0),t.lineTo(e,this.height);for(let e=0;e<this.height;e+=this.gridSize)t.moveTo(0,e),t.lineTo(this.width,e);t.stroke()}clear(t="#0a0a0a"){this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height)}renderGrid(){this.showGrid&&(this.gridCanvas||this.initGrid(),this.ctx.drawImage(this.gridCanvas,0,0))}renderUI(t){const{player:e}=t,s=20,i=25;let a=s;this.ctx.fillStyle="#ffffff",this.ctx.font="16px Arial",this.ctx.fillText(`Nivel: ${e.level}`,s,a),a+=i,this.ctx.fillText(`Vida: ${Math.ceil(e.health)}/${e.maxHealth}`,s,a),a+=i,this.ctx.fillText(`EjÃ©rcito: ${t.armyCount}/${e.armyCapacity}`,s,a),a+=i,this.ctx.fillText(`DaÃ±o: ${e.damage}`,s,a),a+=i,this.renderExperienceBar(e,s,a)}renderExperienceBar(t,e,s){this.ctx.fillStyle="#333",this.ctx.fillRect(e,s,200,20);const n=t.experienceToNextLevel>0?t.experience/t.experienceToNextLevel:0;this.ctx.fillStyle="#00aaff",this.ctx.fillRect(e,s,200*n,20),this.ctx.strokeStyle="#555",this.ctx.lineWidth=2,this.ctx.strokeRect(e,s,200,20),this.ctx.fillStyle="#ffffff",this.ctx.font="12px Arial",this.ctx.textAlign="center",this.ctx.fillText(`XP: ${Math.floor(t.experience)}/${t.experienceToNextLevel}`,e+200/2,s+14),this.ctx.textAlign="left"}renderDebug(t){const s=this.height-20;this.ctx.fillStyle="#00ff00",this.ctx.font="14px monospace";let i=20;this.ctx.fillText(`FPS: ${t.fps}`,i,s),i+=100,this.ctx.fillText(`Enemigos: ${t.enemyCount}`,i,s),i+=140,this.ctx.fillText(`Proyectiles: ${t.projectileCount}`,i,s),i+=160,this.ctx.fillText(`EjÃ©rcito: ${t.armyCount}`,i,s),i+=120,t.particleCount!==void 0&&this.ctx.fillText(`PartÃ­culas: ${t.particleCount}`,i,s)}renderEntity(t){t.render(this.ctx)}renderEntities(t){t.forEach(e=>this.renderEntity(e))}}class bt{constructor(){this.events=new Map}on(t,e){this.events.has(t)||this.events.set(t,[]),this.events.get(t).push(e)}off(t,e){if(!this.events.has(t))return;const s=this.events.get(t),i=s.indexOf(e);i!==-1&&s.splice(i,1)}emit(t,e){if(!this.events.has(t))return;this.events.get(t).forEach(i=>i(e))}clear(){this.events.clear()}}const $={ENEMY_DEFEATED:"enemy_defeated",PLAYER_LEVEL_UP:"player_level_up",PROJECTILE_HIT:"projectile_hit",ARMY_UNIT_ADDED:"army_unit_added",GAME_OVER:"game_over"};class Mt{constructor(t,e,s=0){this.width=t,this.height=e,this.padding=s}clamp(t){const e=this.padding,s=this.padding,i=this.width-t.width-this.padding,a=this.height-t.height-this.padding;t.x=Math.max(e,Math.min(i,t.x)),t.y=Math.max(s,Math.min(a,t.y))}contains(t){return t.x>=this.padding&&t.y>=this.padding&&t.x+t.width<=this.width-this.padding&&t.y+t.height<=this.height-this.padding}isOutOfBounds(t){return!this.contains(t)}getRandomPosition(t=0,e=0){return{x:this.padding+Math.random()*(this.width-t-this.padding*2),y:this.padding+Math.random()*(this.height-e-this.padding*2)}}}class lt extends K{constructor(t,e,s,i,a,n="player"){super(t,e,8,8),this.vx=s,this.vy=i,this.damage=a,this.owner=n,this.speed=400,this.lifetime=3,this.age=0,n==="player"?(this.color="#bd00ff",this.glowColor="#8b00ff"):n==="enemy"?(this.color="#ff0000",this.glowColor="#ff6600"):n==="ally"?(this.color="#00ffff",this.glowColor="#00ffcc"):(this.color="#ffffff",this.glowColor="#ffffff"),this.fromAlly=n==="ally",this.trailPositions=[],this.maxTrailLength=6}update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.age+=t,this.trailPositions.push({x:this.x,y:this.y}),this.trailPositions.length>this.maxTrailLength&&this.trailPositions.shift(),this.age>=this.lifetime&&(this.active=!1)}render(t){for(let l=0;l<this.trailPositions.length;l++){const h=this.trailPositions[l],r=(l+1)/this.trailPositions.length*.5,c=Math.floor(r*255).toString(16).padStart(2,"0");t.fillStyle=this.glowColor+c;const d=this.width*((l+1)/this.trailPositions.length);t.fillRect(h.x-d/2+this.width/2,h.y-d/2+this.height/2,d,d)}const e=this.x+this.width/2,s=this.y+this.height/2,i=this.width*2,a=this.fromAlly?1+Math.sin(this.age*12)*.15:1,n=t.createRadialGradient(e,s,0,e,s,i*a);n.addColorStop(0,this.glowColor+"AA"),n.addColorStop(1,"transparent");const o=t.globalCompositeOperation;if(this.fromAlly&&(t.globalCompositeOperation="lighter"),t.fillStyle=n,t.fillRect(this.x-this.width,this.y-this.height,this.width*3,this.height*3),this.fromAlly&&(t.globalCompositeOperation=o),this.fromAlly){const l=t.createRadialGradient(e,s,0,e,s,this.width);l.addColorStop(0,"#ffffff"),l.addColorStop(.2,this.color),l.addColorStop(1,this.color+"00"),t.fillStyle=l,t.fillRect(this.x,this.y,this.width,this.height)}else t.fillStyle=this.color,t.fillRect(this.x,this.y,this.width,this.height)}isOutOfBounds(t){return t.isOutOfBounds(this)}}class Pt{constructor(t,e,s){this.player=t,this.projectiles=e,this.eventBus=s,this.attackCooldown=.3,this.timeSinceLastAttack=this.attackCooldown,this.autoAim=!0}update(t,e,s=[]){this.timeSinceLastAttack+=t,e&&this.timeSinceLastAttack>=this.attackCooldown&&(this.attack(s),this.timeSinceLastAttack=0)}attack(t){let e,s;if(this.autoAim&&t.length>0){const o=this.findNearestEnemy(t);o&&(e=o.x+o.width/2,s=o.y+o.height/2)}e===void 0&&(e=this.player.x+100,s=this.player.y);const i=e-(this.player.x+this.player.width/2),a=s-(this.player.y+this.player.height/2),n=Math.sqrt(i*i+a*a);if(n>0){const o=i/n,l=a/n,h=400,r=new lt(this.player.x+this.player.width/2-4,this.player.y+this.player.height/2-4,o*h,l*h,this.player.damage,"player");this.projectiles.push(r),this.eventBus&&this.eventBus.emit("player_attack",{projectile:r,player:this.player})}}findNearestEnemy(t){let e=null,s=1/0;const i=this.player.x+this.player.width/2,a=this.player.y+this.player.height/2;for(const n of t){if(!n.active)continue;const o=n.x+n.width/2,l=n.y+n.height/2,h=o-i,r=l-a,c=h*h+r*r;c<s&&(s=c,e=n)}return e}}class kt{constructor(t){this.eventBus=t}checkProjectileEnemyCollisions(t,e){const s=[];for(const i of t)if(!(!i.active||i.owner!=="player"))for(const a of e)a.active&&i.collidesWith(a)&&s.push({projectile:i,enemy:a});return s}checkEnemyPlayerCollisions(t,e){const s=[];for(const i of t)i.active&&i.collidesWith(e)&&s.push(i);return s}resolveProjectileEnemyCollisions(t,e){const s=this.checkProjectileEnemyCollisions(t,e),i=[];for(const{projectile:a,enemy:n}of s){if(!a.active||!n.active)continue;a.active=!1,n.takeDamage(a.damage)&&(i.push(n),this.eventBus&&this.eventBus.emit("enemy_defeated",{enemy:n,experience:n.experienceReward})),this.eventBus&&this.eventBus.emit("projectile_hit",{projectile:a,target:n,damage:a.damage})}return i}resolveAllyProjectileEnemyCollisions(t,e){if(!Array.isArray(t)||!Array.isArray(e))return[];for(const s of t)if(!(!s.active||!s.fromAlly))for(const i of e){if(!i.active)continue;if(typeof s.collidesWith=="function"){if(!s.collidesWith(i))continue}else{const n={left:s.x,right:s.x+(s.width||0),top:s.y,bottom:s.y+(s.height||0)},o=i.getBounds?i.getBounds():{left:i.x,right:i.x+i.width,top:i.y,bottom:i.y+i.height};if(n.right<o.left||n.left>o.right||n.bottom<o.top||n.top>o.bottom)continue}s.active=!1,i.takeDamage(s.damage)&&this.eventBus&&this.eventBus.emit("enemy_defeated",{enemy:i,experience:i.experienceReward}),this.eventBus&&this.eventBus.emit("projectile_hit",{projectile:s,target:i,damage:s.damage});break}}resolveEnemyPlayerCollisions(t,e,s){const i=this.checkEnemyPlayerCollisions(t,e);for(const a of i)a.attack()&&(e.takeDamage(a.damage),this.eventBus&&this.eventBus.emit("player_damaged",{enemy:a,damage:a.damage,playerHealth:e.health}),e.active||this.eventBus&&this.eventBus.emit("game_over",{player:e,reason:"defeated"}))}resolveEnemyAllyCollisions(t,e,s){for(const i of t)if(i.active){for(const a of e)if(a.active&&i.collidesWith(a)&&i.attack()){const n=a.takeDamage(i.damage);this.eventBus&&this.eventBus.emit("ally_damaged",{enemy:i,ally:a,damage:i.damage,died:n}),n&&i.target===a&&(i.target=null)}}}resolveEnemyProjectileCollisions(t,e,s){for(const i of t)if(!(!i.active||!i.fromEnemy)){if(e.active&&this.checkCircleRectCollision(i.x,i.y,i.width/2,e.x,e.y,e.width,e.height)){i.active=!1,e.takeDamage(i.damage),this.eventBus&&this.eventBus.emit("player_damaged",{damage:i.damage,playerHealth:e.health,source:"shaman_projectile"}),!e.active&&this.eventBus&&this.eventBus.emit("game_over",{player:e,reason:"defeated_by_projectile"});continue}for(const a of s)if(a.active&&this.checkCircleRectCollision(i.x,i.y,i.width/2,a.x,a.y,a.width,a.height)){i.active=!1;const n=a.takeDamage(i.damage);this.eventBus&&this.eventBus.emit("ally_hit",{ally:a,damage:i.damage,died:n,source:"shaman_projectile"});break}}}checkCircleRectCollision(t,e,s,i,a,n,o){const l=Math.max(i,Math.min(t,i+n)),h=Math.max(a,Math.min(e,a+o)),r=t-l,c=e-h;return r*r+c*c<s*s}}class st extends K{constructor(t,e,s="warrior"){const n=28*st.getSizeMultiplier(s);super(t,e,n,n),this.type=s,this.stats=this.getStatsForType(s),this.health=this.stats.health,this.maxHealth=this.stats.health,this.damage=this.stats.damage,this.speed=this.stats.speed,this.experienceReward=this.stats.experience,this.target=null,this.detectionRange=500,this.attackRange=this.stats.attackRange||32,this.attackCooldown=this.stats.attackCooldown||1,this.timeSinceLastAttack=0,this.type==="shaman"&&(this.minDistance=150,this.projectileCooldown=2,this.timeSinceLastProjectile=this.projectileCooldown,this.projectiles=[]),this.color=this.stats.color,this._spriteCache={},this.hue=0}static getSizeMultiplier(t){return{warrior:1,tank:2,shaman:.9,assassin:.8}[t]||1}getStatsForType(t){const e={warrior:{health:30,damage:5,speed:80,experience:10,color:"#4a7832",attackRange:32,attackCooldown:1,description:"Guerrero estÃ¡ndar"},tank:{health:90,damage:8,speed:40,experience:30,color:"#2d4d1f",attackRange:40,attackCooldown:1.5,description:"Tanque pesado"},shaman:{health:25,damage:7,speed:60,experience:25,color:"#6b4423",attackRange:200,attackCooldown:2,projectileSpeed:150,description:"ChamÃ¡n de proyectiles"},assassin:{health:21,damage:6,speed:120,experience:20,color:"#7a9b6c",attackRange:28,attackCooldown:.7,description:"Asesino veloz"}};return e[t]||e.warrior}update(t,e=1280,s=720){this.timeSinceLastAttack+=t,this.type==="shaman"&&(this.timeSinceLastProjectile+=t),this.hue+=t*100,this.hue>360&&(this.hue=0),this.target&&(this.type==="shaman"?this.keepDistance(t,e,s):this.chaseTarget(t,e,s))}chaseTarget(t,e=1280,s=720){if(!this.target||!this.target.active||this.target.health<=0){this.target=null,this.vx=0,this.vy=0;return}const i=this.target.x+this.target.width/2,a=this.target.y+this.target.height/2,n=this.x+this.width/2,o=this.y+this.height/2,l=i-n,h=a-o,r=l*l+h*h,c=this.attackRange*this.attackRange;if(r>c){const d=Math.sqrt(r),u=l/d,f=h/d;this.vx=u*this.speed,this.vy=f*this.speed,this.x+=this.vx*t,this.y+=this.vy*t}else this.vx=0,this.vy=0;this.constrainToBounds(e,s)}setTarget(t){this.target=t}findClosestTarget(t,e){let s=null,i=1/0;const a=this.x+this.width/2,n=this.y+this.height/2;if(t&&t.active){const o=t.x+t.width/2,l=t.y+t.height/2,h=o-a,r=l-n,c=h*h+r*r;c<i&&(i=c,s=t)}if(e&&e.length>0)for(const o of e){if(!o.active)continue;const l=o.x+o.width/2,h=o.y+o.height/2,r=l-a,c=h-n,d=r*r+c*c;d<i&&(i=d,s=o)}s&&this.setTarget(s)}keepDistance(t,e=1280,s=720){if(!this.target||!this.target.active||this.target.health<=0){this.target=null,this.vx=0,this.vy=0;return}const i=this.target.x+this.target.width/2,a=this.target.y+this.target.height/2,n=this.x+this.width/2,o=this.y+this.height/2,l=i-n,h=a-o,r=Math.sqrt(l*l+h*h);if(r<this.minDistance){const c=-l/r,d=-h/r;this.vx=c*this.speed,this.vy=d*this.speed,this.x+=this.vx*t,this.y+=this.vy*t}else if(r>this.attackRange){const c=l/r,d=h/r;this.vx=c*this.speed*.5,this.vy=d*this.speed*.5,this.x+=this.vx*t,this.y+=this.vy*t}else this.vx=0,this.vy=0;this.constrainToBounds(e,s)}shootProjectile(t){if(this.type!=="shaman"||!Array.isArray(t))return!1;if(!this.target||!this.target.active||this.target.health<=0)return this.target=null,!1;if(this.timeSinceLastProjectile<this.projectileCooldown)return!1;this.timeSinceLastProjectile=0;const e=this.target.x+this.target.width/2,s=this.target.y+this.target.height/2,i=this.x+this.width/2,a=this.y+this.height/2,n=e-i,o=s-a,l=Math.sqrt(n*n+o*o);if(l===0)return!1;const h=n/l,r=o/l,c={x:i,y:a,width:8,height:8,vx:h*this.stats.projectileSpeed,vy:r*this.stats.projectileSpeed,damage:this.damage,active:!0,fromEnemy:!0,owner:this,update(d){this.x+=this.vx*d,this.y+=this.vy*d},render(d){d.fillStyle="#ff4444",d.beginPath(),d.arc(this.x,this.y,this.width/2,0,Math.PI*2),d.fill(),d.fillStyle="rgba(255, 100, 100, 0.5)",d.beginPath(),d.arc(this.x,this.y,this.width,0,Math.PI*2),d.fill()}};return t.push(c),!0}takeDamage(t){return this.health-=t,this.health<=0?(this.health=0,this.active=!1,!0):!1}canAttack(){if(!this.target)return!1;const t=this.target.x+this.target.width/2,e=this.target.y+this.target.height/2,s=this.x+this.width/2,i=this.y+this.height/2,a=t-s,n=e-i;return Math.sqrt(a*a+n*n)<=this.attackRange&&this.timeSinceLastAttack>=this.attackCooldown}attack(){return this.canAttack()?(this.timeSinceLastAttack=0,!0):!1}render(t,e=null){const s=e!==null?e:performance.now()/1e3;q.renderOrc(t,this.x,this.y,this.width,this.height,s,!1,this._spriteCache,this.type),this.renderHealthBar(t)}renderHealthBar(t){const e=this.width,s=3,i=this.x,a=this.y-8;t.fillStyle="#333",t.fillRect(i,a,e,s);const n=this.maxHealth>0?this.health/this.maxHealth:0;t.fillStyle=n>.5?"#ff0000":"#ff6600",t.fillRect(i,a,e*n,s)}}class Tt{constructor(t,e){this.bounds=t,this.eventBus=e,this.currentWave=0,this.enemiesPerWave=5,this.waveMultiplier=1.3,this.timeBetweenWaves=5,this.timeUntilNextWave=3,this.waveInProgress=!1,this.enemiesSpawnedThisWave=0,this.enemiesToSpawn=0}update(t,e){this.timeUntilNextWave-=t,!this.waveInProgress&&this.timeUntilNextWave<=0&&this.startWave(),this.waveInProgress&&e.length===0&&this.enemiesSpawnedThisWave>=this.enemiesToSpawn&&this.endWave()}startWave(){this.currentWave++,this.waveInProgress=!0,this.enemiesSpawnedThisWave=0,this.enemiesToSpawn=Math.floor(this.enemiesPerWave*Math.pow(this.waveMultiplier,this.currentWave-1)),this.eventBus&&this.eventBus.emit("wave_started",{wave:this.currentWave,enemyCount:this.enemiesToSpawn}),console.log(`ðŸŒŠ Oleada ${this.currentWave} - ${this.enemiesToSpawn} enemigos`)}endWave(){this.waveInProgress=!1,this.timeUntilNextWave=this.timeBetweenWaves,this.eventBus&&this.eventBus.emit("wave_completed",{wave:this.currentWave}),console.log(`âœ… Oleada ${this.currentWave} completada`)}spawnEnemy(t,e){if(!this.waveInProgress||this.enemiesSpawnedThisWave>=this.enemiesToSpawn)return!1;const s=this.getRandomSpawnPosition(),i=this.getEnemyTypeForWave(),a=new st(s.x,s.y,i);return a.setTarget(e),t.push(a),this.enemiesSpawnedThisWave++,!0}getRandomSpawnPosition(){const t=Math.floor(Math.random()*4),e=20;let s,i;switch(t){case 0:s=Math.random()*this.bounds.width,i=-e;break;case 1:s=this.bounds.width+e,i=Math.random()*this.bounds.height;break;case 2:s=Math.random()*this.bounds.width,i=this.bounds.height+e;break;case 3:s=-e,i=Math.random()*this.bounds.height;break}return{x:s,y:i}}getEnemyTypeForWave(){const t=Math.random();return this.currentWave<=2?"warrior":this.currentWave<=5?t<.6?"warrior":"assassin":this.currentWave<=8?t<.4?"warrior":t<.7?"assassin":"shaman":t<.3?"warrior":t<.5?"assassin":t<.75?"shaman":"tank"}getTimeUntilNextWave(){return Math.max(0,this.timeUntilNextWave)}}class at extends K{constructor(t,e,s,i,a=null,n=null,o=null,l=null){const c=28*at.getSizeMultiplier(s);super(t,e,c,c),this.originalType=s,this.damage=Math.floor(i.damage*.7),this.speed=i.speed,this.health=i.maxHealth||i.health||30,this.maxHealth=i.maxHealth||i.health||30,this.owner=null,this.target=null,this.followDistance=80,this.detectionRange=400,this.attackRange=32,this.attackCooldown=1.2,this.timeSinceLastAttack=0,this.mode="follow",this.baseColor=i.color||"#4a7832",this.ghostOpacity=.6,this.flickerSpeed=3,this.flickerPhase=Math.random()*Math.PI*2,this.hue=0,this._spriteCache={},this.particleSystem=a,this.particleTimer=0,this.particleInterval=.05,this.armyArray=n,this.separationRadius=40,this.separationForce=80,this.targetX=t,this.targetY=e,this.followDelay=.1+Math.random()*.15,this.smoothing=.08,this._separationCache={x:0,y:0},this.enemyProjectiles=o,this.allyProjectiles=l,this.originalType==="shaman"&&(this.projectileCooldown=1.5,this.timeSinceLastProjectile=0,this.minDistance=100)}static getSizeMultiplier(t){return{warrior:1,tank:2,shaman:.9,assassin:.8}[t]||1}setOwner(t){this.owner=t}update(t){this.timeSinceLastAttack+=t,typeof this.timeSinceLastProjectile=="number"&&(this.timeSinceLastProjectile+=t),this.hue+=t*50,this.hue>360&&(this.hue=0),this.particleTimer+=t,this.owner&&(this.originalType==="shaman"?this.updateShamanEscort(t):this.target&&this.target.active?(this.mode="attack",this.attackTarget(t)):(this.mode="follow",this.target=null,this.followOwnerWithSeparation(t)),this.spawnEctoplasmTrail())}updateShamanEscort(t){this.mode="escort",this.followOwnerWithSeparation(t),this.target&&this.target.active?this.shootProjectile():(this.findNearestEnemyInRange(),this.target&&this.target.active&&this.shootProjectile())}findNearestEnemyInRange(){if((!this.target||!this.target.active)&&(this.target=null),this.target&&this.target.active){const t=this.x+this.width/2,e=this.y+this.height/2,s=this.target.x+this.target.width/2,i=this.target.y+this.target.height/2,a=s-t,n=i-e;if(Math.sqrt(a*a+n*n)<this.detectionRange)return}}followOwnerWithSeparation(t){const e=this.owner.x+this.owner.width/2,s=this.owner.y+this.owner.height/2,i=e-this.targetX,a=s-this.targetY;this.targetX+=i*this.smoothing,this.targetY+=a*this.smoothing;const n=this.x+this.width/2,o=this.y+this.height/2,l=this.targetX-n,h=this.targetY-o,r=Math.sqrt(l*l+h*h),c=this.calculateSeparation();if(r>this.followDistance){const d=l/r,u=h/r;this.vx=d*this.speed+c.x,this.vy=u*this.speed+c.y,this.x+=this.vx*t,this.y+=this.vy*t}else this.vx=c.x,this.vy=c.y,this.x+=this.vx*t,this.y+=this.vy*t}calculateSeparation(){if(this._separationCache.x=0,this._separationCache.y=0,!this.armyArray||this.armyArray.length<=1)return this._separationCache;let t=0,e=0,s=0;const i=this.x+this.width/2,a=this.y+this.height/2;for(const n of this.armyArray){if(n===this||!n.active)continue;const o=n.x+n.width/2,l=n.y+n.height/2,h=i-o,r=a-l,c=h*h+r*r,d=this.separationRadius*this.separationRadius;if(c>0&&c<d){const u=Math.sqrt(c),f=this.separationForce*(1-u/this.separationRadius);t+=h/u*f,e+=r/u*f,s++}}return s>0&&(t/=s,e/=s),this._separationCache.x=t,this._separationCache.y=e,this._separationCache}spawnEctoplasmTrail(){var e;if(!(!((e=this.particleSystem)!=null&&e.createTrail)||!(Math.abs(this.vx)>10||Math.abs(this.vy)>10))&&this.particleTimer>=this.particleInterval){this.particleTimer=0;const s=this.x+this.width/2,i=this.y+this.height/2,a=(Math.random()-.5)*this.width,n=(Math.random()-.5)*this.height;this.particleSystem.createTrail(s+a,i+n,"#00ffff")}}attackTarget(t){if(!this.target||!this.target.active){this.target=null,this.vx=0,this.vy=0;return}if(this.originalType==="shaman"){this.shaman_attackRanged(t);return}const e=this.target.x+this.target.width/2,s=this.target.y+this.target.height/2,i=this.x+this.width/2,a=this.y+this.height/2,n=e-i,o=s-a,l=n*n+o*o,h=this.attackRange*this.attackRange;if(l>h){const r=Math.sqrt(l),c=n/r,d=o/r;this.vx=c*this.speed,this.vy=d*this.speed,this.x+=this.vx*t,this.y+=this.vy*t}else if(this.vx=0,this.vy=0,this.timeSinceLastAttack>=this.attackCooldown){const r=this.target.takeDamage(this.damage);this.timeSinceLastAttack=0,r&&(this.target=null)}}shaman_attackRanged(t){if(!this.target||!this.target.active){this.target=null,this.vx=0,this.vy=0;return}const e=this.target.x+(this.target.width||0)/2,s=this.target.y+(this.target.height||0)/2,i=this.x+(this.width||0)/2,a=this.y+(this.height||0)/2,n=e-i,o=s-a,l=Math.sqrt(n*n+o*o);if(!isFinite(l)||l<0){this.vx=0,this.vy=0;return}if(l<(this.minDistance||100)){const h=-n/(l||1),r=-o/(l||1);this.vx=h*(this.speed||60)*.5,this.vy=r*(this.speed||60)*.5}else if(l>(this.detectionRange||400)){this.target=null,this.vx=0,this.vy=0;return}else this.vx=0,this.vy=0;this.x+=this.vx*t,this.y+=this.vy*t}shootProjectile(){if(this.originalType!=="shaman")return;if(!this.target||!this.target.active){this.target=null;return}if(typeof this.timeSinceLastProjectile=="number"&&this.timeSinceLastProjectile<(this.projectileCooldown||1))return;const t=this.target.x+(this.target.width||0)/2,e=this.target.y+(this.target.height||0)/2,s=this.x+(this.width||0)/2,i=this.y+(this.height||0)/2;let a=t-s,n=e-i;const o=Math.sqrt(a*a+n*n)||1;a/=o,n/=o;const l=320,h=a*l,r=n*l,c=8,d=s-c/2,u=i-c/2;let f;try{f=new lt(d,u,h,r,this.damage||5,"ally")}catch{f={x:d,y:u,width:c,height:c,vx:h,vy:r,damage:this.damage||5,active:!0,fromAlly:!0,owner:"ally",update(p){this.x+=this.vx*p,this.y+=this.vy*p},render(p){p.fillStyle="#00ffff",p.fillRect(this.x,this.y,this.width,this.height)},getBounds(){return{left:this.x,right:this.x+this.width,top:this.y,bottom:this.y+this.height}},collidesWith(p){if(!p||!p.getBounds)return!1;const C=this.getBounds(),E=p.getBounds();return!(C.right<E.left||C.left>E.right||C.bottom<E.top||C.top>E.bottom)}}}try{f.fromAlly=!0}catch{}f.owner="ally",Array.isArray(this.allyProjectiles)&&this.allyProjectiles.push(f),this.timeSinceLastProjectile=0}findNearestEnemy(t){let e=null,s=1/0;const i=this.x+this.width/2,a=this.y+this.height/2;for(const n of t){if(!n.active)continue;const o=n.x+n.width/2,l=n.y+n.height/2,h=o-i,r=l-a,c=Math.sqrt(h*h+r*r);c<s&&c<this.detectionRange&&(s=c,e=n)}this.target=e}heal(t){this.active&&(this.health=Math.min(this.maxHealth,this.health+t))}takeDamage(t){return this.active?(this.health-=t,this.health<=0?(this.health=0,this.die(),!0):!1):!1}die(){if(this.active=!1,this.particleSystem){const t=this.x+this.width/2,e=this.y+this.height/2;this.particleSystem.createExplosion(t,e,{count:20,color:"#00ffff",speed:100,size:3});for(let s=0;s<8;s++){const i=s/8*Math.PI*2,a=Math.cos(i)*15,n=Math.sin(i)*15;this.particleSystem.createTrail(t+a,e+n,"#0099ff")}}}render(t,e=null){const s=e!==null?e:performance.now()/1e3;q.renderOrc(t,this.x,this.y,this.width,this.height,s,!0,this._spriteCache,this.originalType),this.renderHealthBar(t)}renderHealthBar(t){if(this.health>=this.maxHealth)return;const e=this.width,s=2,i=this.x,a=this.y-6;t.fillStyle="rgba(0, 0, 0, 0.4)",t.fillRect(i,a,e,s);const n=this.maxHealth>0?this.health/this.maxHealth:0;let o;n>.6?o="#00ffff":n>.3?o="#0099ff":o="#6600ff",t.fillStyle=o,t.fillRect(i,a,e*n,s),t.fillStyle=`rgba(255, 255, 255, ${.3*n})`,t.fillRect(i,a,e*n*.5,s*.5)}}class Bt{constructor(t={}){this.enabled=t.enabled!==!1,this.quality=t.quality||"high",this.qualitySettings={low:{vignetteRadius:.6,glowSamples:2,lightningSegments:3,vignetteStrength:.2},medium:{vignetteRadius:.5,glowSamples:4,lightningSegments:5,vignetteStrength:.3},high:{vignetteRadius:.4,glowSamples:6,lightningSegments:8,vignetteStrength:.3}},this.chromaticAberration=0,this.glowEnabled=!0}applyVignette(t,e,s){if(!this.enabled)return;const i=this.qualitySettings[this.quality],a=t.createRadialGradient(e/2,s/2,e*.3,e/2,s/2,e*.7);a.addColorStop(0,"rgba(0, 0, 0, 0)"),a.addColorStop(1,`rgba(0, 0, 0, ${i.vignetteStrength})`),t.fillStyle=a,t.fillRect(0,0,e,s)}drawGlow(t,e,s,i,a,n=.5){if(!this.enabled||!this.glowEnabled)return;const l=this.qualitySettings[this.quality].glowSamples,h=a.replace("#",""),r=parseInt(h.substr(0,2),16),c=parseInt(h.substr(2,2),16),d=parseInt(h.substr(4,2),16);t.save();for(let u=0;u<l;u++){const f=i*(1+u*.3),M=n*(1-u/l),p=t.createRadialGradient(e,s,0,e,s,f);p.addColorStop(0,`rgba(${r}, ${c}, ${d}, ${M})`),p.addColorStop(.5,`rgba(${r}, ${c}, ${d}, ${M*.3})`),p.addColorStop(1,`rgba(${r}, ${c}, ${d}, 0)`),t.fillStyle=p,t.fillRect(e-f,s-f,f*2,f*2)}t.restore()}drawDistortion(t,e,s,i,a,n,o){if(!this.enabled)return;const l=t.getImageData(Math.max(0,e-i),Math.max(0,s-i),Math.min(i*2,n),Math.min(i*2,o));t.save(),t.globalAlpha=.8,t.putImageData(l,e-i+a*2,s-i),t.globalAlpha=1,t.restore()}drawLightning(t,e,s,i,a,n,o){if(!this.enabled)return;const h=this.qualitySettings[this.quality].lightningSegments,r=15;t.save(),t.strokeStyle=n||"#00ffff",t.lineWidth=o||2,t.lineCap="round",t.beginPath(),t.moveTo(e,s);const c=i-e,d=a-s,u=[{x:e,y:s}];for(let f=1;f<h;f++){const M=f/h,p=e+c*M+(Math.random()-.5)*r,C=s+d*M+(Math.random()-.5)*r;u.push({x:p,y:C}),t.lineTo(p,C)}t.lineTo(i,a),t.stroke(),t.strokeStyle="#ffffff",t.lineWidth=(o||2)*.3,t.beginPath(),t.moveTo(e,s);for(const f of u)t.lineTo(f.x,f.y);t.lineTo(i,a),t.stroke(),t.restore()}getScreenShake(t){if(!this.enabled)return{x:0,y:0};const e=t||1;return{x:(Math.random()-.5)*e*4,y:(Math.random()-.5)*e*4}}drawEnergyRing(t,e,s,i,a,n){if(!this.enabled)return;const l=1-i/a;t.save(),t.strokeStyle=(n||"#8b00ff")+Math.floor(l*255).toString(16).padStart(2,"0"),t.lineWidth=3,t.beginPath(),t.arc(e,s,i,0,Math.PI*2),t.stroke(),t.restore()}applyGhostFilter(t,e,s){this.enabled&&(t.save(),t.globalCompositeOperation="screen",t.fillStyle="rgba(0, 200, 255, 0.1)",t.fillRect(0,0,e,s),t.globalCompositeOperation="source-over",t.restore())}setQuality(t){this.qualitySettings[t]&&(this.quality=t)}setEnabled(t){this.enabled=t}setGlowEnabled(t){this.glowEnabled=t}}class Rt{constructor(t,e){this.width=t,this.height=e,this.showCardSelection=!1,this.selectedCard=null,this.availableCards=[],this.cardWidth=200,this.cardHeight=280,this.cardSpacing=30,this.cardRadius=10,this.cardHoverIndex=-1,this.hoverScale=1,this.hoverTargetScale=1,this.colors={cardBg:"#1a1a2e",cardBorder:"#bd00ff",cardHover:"#ff00ff",textPrimary:"#ffffff",textSecondary:"#aaaaaa",rarityCommon:"#7f8c8d",rarityRare:"#3498db",rarityEpic:"#9b59b6",rarityLegendary:"#f39c12"}}update(t){this.hoverScale+=(this.hoverTargetScale-this.hoverScale)*10*t}render(t,e){this.renderHUD(t,e.player,e.armyCount),this.showCardSelection&&this.renderCardSelection(t)}renderHUD(t,e,s){const a=window.innerWidth<768?1.5:1,n=20*a,o=200*a,l=25*a;t.save(),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,this.width,80*a),t.fillStyle=this.colors.textPrimary,t.font=`bold ${Math.floor(24*a)}px Arial`,t.fillText(`Nivel ${e.level}`,n,35*a);const h=n,r=45*a,c=e.xp/e.xpToNextLevel;t.fillStyle="rgba(255, 255, 255, 0.2)",this.roundRect(t,h,r,o,l,5,!0,!1),t.fillStyle="#bd00ff",this.roundRect(t,h,r,o*c,l,5,!0,!1),t.fillStyle=this.colors.textPrimary,t.font=`${Math.floor(14*a)}px Arial`,t.fillText(`XP: ${Math.floor(e.xp)}/${e.xpToNextLevel}`,h+5,r+17*a);const d=o+n*2+20,u=45*a,f=e.health/e.maxHealth;t.fillStyle="rgba(255, 255, 255, 0.2)",this.roundRect(t,d,u,o,l,5,!0,!1);const M=f>.5?"#00ff00":f>.25?"#ffaa00":"#ff0000";t.fillStyle=M,this.roundRect(t,d,u,o*f,l,5,!0,!1),t.fillStyle=this.colors.textPrimary,t.font=`${Math.floor(14*a)}px Arial`,t.fillText(`HP: ${Math.floor(e.health)}/${e.maxHealth}`,d+5,u+17*a);const p=this.width-n;t.font=`bold ${Math.floor(24*a)}px Arial`,t.fillStyle="#00ffff",t.textAlign="right",t.fillText(`ðŸ‘» ${s}/${e.maxArmy}`,p,35*a),t.font=`${Math.floor(16*a)}px Arial`,t.fillStyle=this.colors.textSecondary,t.fillText(`Puntos: ${Math.floor(e.points)}`,p,60*a),t.textAlign="left",t.restore()}renderCardSelection(t){t.save(),t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(0,0,this.width,this.height),t.fillStyle=this.colors.textPrimary,t.font="bold 48px Arial",t.textAlign="center",t.fillText("Â¡NIVEL SUBIDO!",this.width/2,120),t.font="24px Arial",t.fillStyle=this.colors.textSecondary,t.fillText("Selecciona una mejora:",this.width/2,170);const e=this.availableCards.length*(this.cardWidth+this.cardSpacing)-this.cardSpacing,s=(this.width-e)/2,i=220;for(let a=0;a<this.availableCards.length;a++){const n=this.availableCards[a],o=s+a*(this.cardWidth+this.cardSpacing),l=i,h=a===this.cardHoverIndex?this.hoverScale:1,r=a===this.cardHoverIndex?-20:0;this.renderCard(t,n,o,l+r,h,a===this.cardHoverIndex)}t.textAlign="left",t.restore()}renderCard(t,e,s,i,a,n){t.save();const o=s+this.cardWidth/2,l=i+this.cardHeight/2;t.translate(o,l),t.scale(a,a),t.translate(-o,-l),n&&(t.shadowBlur=30,t.shadowColor=this.colors.cardHover),t.fillStyle=this.colors.cardBg,this.roundRect(t,s,i,this.cardWidth,this.cardHeight,this.cardRadius,!0,!1),t.strokeStyle=n?this.colors.cardHover:this.colors.cardBorder,t.lineWidth=n?4:2,this.roundRect(t,s,i,this.cardWidth,this.cardHeight,this.cardRadius,!1,!0);const h=this.colors[`rarity${e.rarity}`]||this.colors.rarityCommon;t.fillStyle=h,this.roundRect(t,s,i,this.cardWidth,40,this.cardRadius,!0,!1),t.fillStyle=this.colors.textPrimary,t.font="bold 18px Arial",t.textAlign="center",t.fillText(e.name,s+this.cardWidth/2,i+27),t.font="64px Arial",t.fillText(e.icon,s+this.cardWidth/2,i+120),t.font="14px Arial",t.fillStyle=this.colors.textSecondary;const r=this.wrapText(e.description,this.cardWidth-20);for(let c=0;c<r.length;c++)t.fillText(r[c],s+this.cardWidth/2,i+160+c*20);t.font="bold 24px Arial",t.fillStyle=e.valueColor||"#00ff00",t.fillText(e.value,s+this.cardWidth/2,i+this.cardHeight-30),t.textAlign="left",t.restore()}wrapText(t,e){const s=t.split(" "),i=[];let a="";for(const n of s){const o=a+(a?" ":"")+n;o.length*8>e?(a&&i.push(a),a=n):a=o}return a&&i.push(a),i}roundRect(t,e,s,i,a,n,o,l){t.beginPath(),t.moveTo(e+n,s),t.lineTo(e+i-n,s),t.quadraticCurveTo(e+i,s,e+i,s+n),t.lineTo(e+i,s+a-n),t.quadraticCurveTo(e+i,s+a,e+i-n,s+a),t.lineTo(e+n,s+a),t.quadraticCurveTo(e,s+a,e,s+a-n),t.lineTo(e,s+n),t.quadraticCurveTo(e,s,e+n,s),t.closePath(),o&&t.fill(),l&&t.stroke()}handleCardClick(t,e){if(!this.showCardSelection)return null;const s=this.availableCards.length*(this.cardWidth+this.cardSpacing)-this.cardSpacing,i=(this.width-s)/2,a=220;for(let n=0;n<this.availableCards.length;n++){const o=i+n*(this.cardWidth+this.cardSpacing),l=a+(n===this.cardHoverIndex?-20:0);if(t>=o&&t<=o+this.cardWidth&&e>=l&&e<=l+this.cardHeight)return this.availableCards[n]}return null}handleCardHover(t,e){if(!this.showCardSelection){this.cardHoverIndex=-1;return}const s=this.availableCards.length*(this.cardWidth+this.cardSpacing)-this.cardSpacing,i=(this.width-s)/2,a=220;let n=!1;for(let o=0;o<this.availableCards.length;o++){const l=i+o*(this.cardWidth+this.cardSpacing),h=a;if(t>=l&&t<=l+this.cardWidth&&e>=h&&e<=h+this.cardHeight){this.cardHoverIndex=o,this.hoverTargetScale=1.1,n=!0;break}}n||(this.cardHoverIndex=-1,this.hoverTargetScale=1)}showCards(t){this.availableCards=t,this.showCardSelection=!0,this.cardHoverIndex=-1}hideCards(){this.showCardSelection=!1,this.availableCards=[],this.cardHoverIndex=-1}}class wt{constructor(t){this.eventBus=t,this.cardLibrary=[{id:"damage_1",name:"Fuego Oscuro",description:"Aumenta el daÃ±o de tus proyectiles",icon:"ðŸ”¥",rarity:"Common",type:"damage",value:"+5 DaÃ±o",valueColor:"#ff6600",effect:e=>{e.damage+=5}},{id:"damage_2",name:"Llamas Infernales",description:"Gran aumento de daÃ±o",icon:"ðŸ’¥",rarity:"Rare",type:"damage",value:"+15 DaÃ±o",valueColor:"#ff0000",effect:e=>{e.damage+=15}},{id:"army_1",name:"Llamado Espectral",description:"Aumenta tu capacidad de ejÃ©rcito",icon:"ðŸ‘»",rarity:"Common",type:"army",value:"+3 Aliados",valueColor:"#00ffff",effect:e=>{e.baseArmyCapacity+=3,e.updateArmyCapacity()}},{id:"army_2",name:"LegiÃ³n de Sombras",description:"Gran aumento de capacidad de ejÃ©rcito",icon:"ðŸ‘¥",rarity:"Epic",type:"army",value:"+8 Aliados",valueColor:"#00aaff",effect:e=>{e.baseArmyCapacity+=8,e.updateArmyCapacity()}},{id:"health_1",name:"Vigor NecrÃ³tico",description:"Aumenta tu vida mÃ¡xima",icon:"â¤ï¸",rarity:"Common",type:"health",value:"+25 Vida",valueColor:"#00ff00",effect:e=>{e.maxHealth+=25,e.health=Math.min(e.health+25,e.maxHealth)}},{id:"health_2",name:"Esencia Vital",description:"Restaura y aumenta vida",icon:"ðŸ’š",rarity:"Rare",type:"health",value:"+50 Vida",valueColor:"#00ff00",effect:e=>{e.maxHealth+=50,e.health=e.maxHealth}},{id:"speed_1",name:"FrenesÃ­",description:"Aumenta velocidad de ataque",icon:"âš¡",rarity:"Common",type:"attackSpeed",value:"+20% Velocidad",valueColor:"#ffff00",effect:e=>{e.attackSpeed*=.8}},{id:"speed_2",name:"Tormenta Arcana",description:"Gran aumento de velocidad de ataque",icon:"âš¡âš¡",rarity:"Epic",type:"attackSpeed",value:"+40% Velocidad",valueColor:"#ffaa00",effect:e=>{e.attackSpeed*=.6}},{id:"move_1",name:"Paso Fantasma",description:"Aumenta velocidad de movimiento",icon:"ðŸ’¨",rarity:"Common",type:"movement",value:"+15% Velocidad",valueColor:"#aaaaff",effect:e=>{e.speed*=1.15}},{id:"move_2",name:"Viento Espectral",description:"Gran aumento de velocidad",icon:"ðŸŒªï¸",rarity:"Rare",type:"movement",value:"+30% Velocidad",valueColor:"#8888ff",effect:e=>{e.speed*=1.3}},{id:"special_1",name:"Cosecha de Almas",description:"Los enemigos dan mÃ¡s puntos",icon:"âœ¨",rarity:"Epic",type:"special",value:"+50% Puntos",valueColor:"#bd00ff",effect:e=>{e.pointsMultiplier=(e.pointsMultiplier||1)*1.5}},{id:"special_2",name:"RegeneraciÃ³n",description:"Regenera vida con el tiempo",icon:"ðŸ”‹",rarity:"Legendary",type:"special",value:"+2 Vida/seg",valueColor:"#f39c12",effect:e=>{e.healthRegen=(e.healthRegen||0)+2}},{id:"special_3",name:"Poder Definitivo",description:"Mejora mÃºltiples stats",icon:"ðŸ‘‘",rarity:"Legendary",type:"special",value:"Todo +10%",valueColor:"#ffd700",effect:e=>{e.damage=Math.floor(e.damage*1.1),e.maxHealth=Math.floor(e.maxHealth*1.1),e.speed*=1.1,e.attackSpeed*=.9,e.baseArmyCapacity+=2,e.updateArmyCapacity()}},{id:"healing_unlock",name:"Despertar Sangriento",description:"Desbloquea tu aura de curaciÃ³n para aliados",icon:"ðŸ©¸",rarity:"Epic",type:"special",value:"Aura Desbloqueada",valueColor:"#ff00ff",conditions:e=>!e.hasHealingUnlocked,effect:e=>{e.hasHealingUnlocked=!0,console.log("âœ¨ Aura de curaciÃ³n desbloqueada")}},{id:"healing_range",name:"VÃ­nculo Vital",description:"Expande el rango de tu aura de curaciÃ³n",icon:"ðŸ’œ",rarity:"Rare",type:"special",value:"+40 Rango",valueColor:"#ff00ff",conditions:e=>e.hasHealingUnlocked,effect:e=>{e.healingAuraBonus||(e.healingAuraBonus=0),e.healingAuraBonus+=40,console.log("ðŸ’œ Rango del aura expandido")}},{id:"master_souls",name:"Maestro de Almas",description:"Aumenta tu capacidad de invocaciÃ³n",icon:"âšœï¸",rarity:"Epic",type:"army",value:"+2 Aliados",valueColor:"#00ffff",effect:e=>{e.baseArmyCapacity+=2,e.updateArmyCapacity(),console.log("âšœï¸ Capacidad de ejÃ©rcito aumentada")}}],this.rarityWeights={Common:60,Rare:25,Epic:12,Legendary:3}}generateCards(t,e,s=null){const i=[],a=new Set,n={...this.rarityWeights};for(e>=5&&(n.Common=45,n.Rare=35,n.Epic=15,n.Legendary=5),e>=10&&(n.Common=30,n.Rare=40,n.Epic=20,n.Legendary=10);i.length<t;){const o=this.selectRarity(n),l=this.cardLibrary.filter(h=>{const r=!a.has(h.id),c=h.rarity===o,d=!h.conditions||s&&h.conditions(s);return r&&c&&d});if(l.length>0){const h=l[Math.floor(Math.random()*l.length)];i.push({...h}),a.add(h.id)}else break}return i}selectRarity(t){const e=Object.values(t).reduce((i,a)=>i+a,0);let s=Math.random()*e;for(const[i,a]of Object.entries(t))if(s-=a,s<=0)return i;return"Common"}applyCard(t,e){e&&(e.appliedCards||(e.appliedCards=new Set),!e.appliedCards.has(t.id)&&(t.effect&&t.effect(e),e.appliedCards.add(t.id),this.eventBus&&this.eventBus.emit("CARD_APPLIED",{card:t,player:e})))}}class At{constructor(t){if(this.canvas=t,this.ctx=t.getContext("2d"),!this.ctx)throw new Error("No se pudo obtener el contexto 2D del canvas");this.setupCanvasResponsiveness(),this.width=t.width,this.height=t.height,this.inputManager=new vt(t),this.entityManager=new St,this.renderer=new Ct(this.ctx,this.width,this.height),this.eventBus=new bt,this.bounds=new Mt(this.width,this.height),this.particleSystem=new it({maxParticles:800,enabled:!0}),this.shaderEffects=new Bt({quality:"high",enabled:!0}),this.uiManager=new Rt(this.width,this.height),this.cardSystem=new wt(this.eventBus),this.player=new gt(this.width/2,this.height/2),this.player.eventBus=this.eventBus,this.enemies=[],this.army=[],this.projectiles=[],this.allyProjectiles=[],this.enemyProjectiles=[],this.attackController=new Pt(this.player,this.projectiles,this.eventBus),this.collisionSystem=new kt(this.eventBus),this.waveManager=new Tt(this.bounds,this.eventBus),this.enemySpawnCooldown=.5,this.timeSinceLastSpawn=0,this.autoAttackCooldown=.3,this.timeSinceAutoAttack=0,this.entityManager.register("enemies",this.enemies),this.entityManager.register("army",this.army),this.entityManager.register("projectiles",this.projectiles),this.entityManager.register("allyProjectiles",this.allyProjectiles),this.entityManager.register("enemyProjectiles",this.enemyProjectiles),this.running=!1,this.paused=!1,this.lastTime=0,this.gameTime=0,this.fps=0,this.frameCount=0,this.lastFpsUpdate=0,this.mouseX=0,this.mouseY=0,this.showDebug=!0,this.setupEventListeners(),this.setupMouseListeners()}setupCanvasResponsiveness(){this.isMobile=window.innerWidth<768,this.canvas.width=1280,this.canvas.height=720,this.uiScale=this.isMobile?1.5:1}setupEventListeners(){this.eventBus.on($.PLAYER_LEVEL_UP,t=>{console.log(`Â¡Nivel ${t.level} alcanzado!`),this.particleSystem.createExplosion(t.player.x+t.player.width/2,t.player.y+t.player.height/2,{count:30,color:"#8b00ff",speed:150,size:6}),this.pauseForCards(t.level)}),this.eventBus.on($.ENEMY_DEFEATED,t=>{this.player.addExperience(t.experience||10),this.particleSystem.createExplosion(t.enemy.x+t.enemy.width/2,t.enemy.y+t.enemy.height/2,{count:12,color:t.enemy.color,speed:120,size:4}),this.army.length<this.player.armyCapacity&&this.convertEnemyToAlly(t.enemy)}),this.eventBus.on($.PROJECTILE_HIT,t=>{this.particleSystem.createImpact(t.target.x+t.target.width/2,t.target.y+t.target.height/2,t.projectile.vx,t.projectile.vy)}),this.eventBus.on($.GAME_OVER,t=>{console.log("âŒ Game Over"),this.stop()})}start(){this.running=!0,this.lastTime=performance.now(),this.loop(this.lastTime)}stop(){this.running=!1}loop(t){if(!this.running)return;const e=(t-this.lastTime)/1e3;this.lastTime=t,this.updateFPS(t),this.update(e),this.render(),requestAnimationFrame(s=>this.loop(s))}updateFPS(t){this.frameCount++,t-this.lastFpsUpdate>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFpsUpdate=t)}update(t){if(this.paused){this.uiManager.update(t);return}this.gameTime+=t,t=Math.min(t,.1),this.waveManager.update(t,this.enemies),this.timeSinceLastSpawn+=t,this.timeSinceLastSpawn>=this.enemySpawnCooldown&&this.waveManager.spawnEnemy(this.enemies,this.player)&&(this.timeSinceLastSpawn=0);const e=this.inputManager.getMovementInput();this.player.setInput(e.x,e.y);const s=this.inputManager.isAttackPressed();this.attackController.update(t,s,this.enemies),this.updateAutoAttack(t),this.player.update(t),this.bounds.clamp(this.player),this.enemies.forEach(a=>{a.findClosestTarget(this.player,this.army),a.type==="shaman"&&a.active&&a.shootProjectile(this.enemyProjectiles)}),this.army.forEach(a=>{this.enemies.length>0&&(a.originalType==="shaman"||a.mode==="follow")&&a.findNearestEnemy(this.enemies)}),this.entityManager.update("army",t),this.entityManager.update("enemies",t,this.width,this.height),this.entityManager.update("projectiles",t),this.entityManager.update("allyProjectiles",t),this.entityManager.update("enemyProjectiles",t);for(let a=this.projectiles.length-1;a>=0;a--)this.bounds.isOutOfBounds(this.projectiles[a])&&(this.projectiles[a].active=!1);for(let a=this.enemyProjectiles.length-1;a>=0;a--)this.bounds.isOutOfBounds(this.enemyProjectiles[a])&&(this.enemyProjectiles[a].active=!1);for(let a=this.allyProjectiles.length-1;a>=0;a--)this.bounds.isOutOfBounds(this.allyProjectiles[a])&&(this.allyProjectiles[a].active=!1);this.army.forEach(a=>this.bounds.clamp(a)),this.collisionSystem.resolveProjectileEnemyCollisions(this.projectiles,this.enemies),this.allyProjectiles&&this.allyProjectiles.length>0&&this.collisionSystem.resolveAllyProjectileEnemyCollisions(this.allyProjectiles,this.enemies),this.collisionSystem.resolveEnemyPlayerCollisions(this.enemies,this.player,t),this.collisionSystem.resolveEnemyAllyCollisions(this.enemies,this.army,t),this.collisionSystem.resolveEnemyProjectileCollisions(this.enemyProjectiles,this.player,this.army),this.particleSystem.update(t),this.frameCount++;let i=0;for(let a=this.army.length-1;a>=0;a--)(!this.army[a].active||this.army[a].health<=0)&&(this.army.splice(a,1),i++);i>0&&this.frameCount%30===0&&console.log(`ðŸ§¹ GC: ${i} aliado(s) eliminado(s) - Contador real: ${this.army.length}/${this.player.armyCapacity}`),this.uiManager.update(t),this.player.applyHealingAura(this.army,t),(this.player.vx!==0||this.player.vy!==0)&&this.particleSystem.createTrail(this.player.x+this.player.width/2,this.player.y+this.player.height/2,"#bd00ff")}convertEnemyToAlly(t){t.active=!1;const e=new at(t.x,t.y,t.type,{health:t.maxHealth,maxHealth:t.maxHealth,damage:t.damage,speed:t.speed,color:t.color},this.particleSystem,this.army,this.enemyProjectiles,this.allyProjectiles);e.setOwner(this.player),this.army.push(e),this.particleSystem.createGhostConversion(t.x+t.width/2,t.y+t.height/2),this.player.updateArmyCapacity(),this.eventBus.emit($.ARMY_UNIT_ADDED,{ally:e,armySize:this.army.length}),console.log(`ðŸ‘» Aliado invocado (${this.army.length}/${this.player.armyCapacity})`)}updateAutoAttack(t){if(this.timeSinceAutoAttack+=t,!(!this.inputManager.virtualJoystick||!this.inputManager.virtualJoystick.isMobile)&&this.timeSinceAutoAttack>=this.autoAttackCooldown&&this.enemies.length>0){let e=null,s=1/0;const i=this.player.x+this.player.width/2,a=this.player.y+this.player.height/2;for(const n of this.enemies){if(!n.active)continue;const o=n.x+n.width/2,l=n.y+n.height/2,h=o-i,r=l-a,c=Math.sqrt(h*h+r*r);c<200&&c<s&&(s=c,e=n)}if(e){const n=e.x-this.player.x,o=e.y-this.player.y,l=Math.sqrt(n*n+o*o)||1,h=n/l*400,r=o/l*400;this.attackController.createProjectile(h,r),this.timeSinceAutoAttack=0}}}render(){this.renderer.clear(),this.renderer.showGrid=this.showDebug,this.renderer.renderGrid(),this.particleSystem.render(this.ctx);const t=["projectiles","allyProjectiles","enemyProjectiles","army","enemies"];this.entityManager.renderAll(this.ctx,t,this.gameTime),this.player.render(this.ctx,this.gameTime),this.shaderEffects.applyVignette(this.ctx,this.width,this.height),this.uiManager.render(this.ctx,{player:this.player,armyCount:this.army.length});const e=this.inputManager.getVirtualJoystick();e&&e.isMobile&&e.render(this.ctx),this.showDebug&&!this.isMobile&&this.renderer.renderDebug({fps:this.fps,enemyCount:this.enemies.length,projectileCount:this.projectiles.length,allyProjectileCount:this.allyProjectiles.length,enemyProjectileCount:this.enemyProjectiles.length,armyCount:this.army.length,particleCount:this.particleSystem.getCount()})}setupMouseListeners(){this.mouseMoveListener=t=>{const e=this.canvas.getBoundingClientRect();this.mouseX=t.clientX-e.left,this.mouseY=t.clientY-e.top,this.uiManager.showCardSelection&&this.uiManager.handleCardHover(this.mouseX,this.mouseY)},this.mouseClickListener=t=>{const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;this.handleCardClick(s,i)},this.canvas.addEventListener("mousemove",this.mouseMoveListener),this.canvas.addEventListener("click",this.mouseClickListener)}pauseForCards(t){this.paused=!0;const e=this.cardSystem.generateCards(3,t,this.player);this.uiManager.showCards(e),console.log("ðŸŽ´ Selector de cartas activado")}handleCardClick(t,e){if(!this.paused)return;const s=this.uiManager.handleCardClick(t,e);s?(console.log(`âœ… Carta seleccionada: ${s.name}`),this.cardSystem.applyCard(s,this.player),this.particleSystem.createExplosion(this.player.x+this.player.width/2,this.player.y+this.player.height/2,{count:25,color:"#bd00ff",speed:140,size:5}),this.uiManager.hideCards(),this.paused=!1):console.log("âš ï¸ Click fuera de cartas - presiona dentro de una carta para seleccionarla")}destroy(){this.stop();const t=this.mouseMoveListener,e=this.mouseClickListener;t&&this.canvas.removeEventListener("mousemove",t),e&&this.canvas.removeEventListener("click",e),this.eventBus&&this.eventBus.clear(),this.inputManager&&this.inputManager.destroy(),console.log("ðŸ§¹ Game destruido y listeners limpiados")}}class Et extends et{constructor(){super(),this.game=null}enter(t={}){console.log("ðŸŽ® Iniciando partida..."),this.sceneManager.pauseLoop(),this.game=new At(this.canvas),this.game.eventBus.on("game_over",e=>{this.handleGameOver(e)}),this.game.start()}exit(){console.log("ðŸ‘‹ Saliendo del juego..."),this.game&&(this.game.stop(),this.game.destroy(),this.game=null),this.sceneManager.resumeLoop()}handleGameOver(t){if(console.log("ðŸ’€ Juego terminado, cambiando a Game Over..."),this.game){this.game.stop();const e={level:this.game.player.level,kills:this.game.player.points,armySize:this.game.army.length,wave:this.game.waveManager.currentWave,playerHealth:this.game.player.health};this.sceneManager.switchTo("gameover",e)}}update(t){}render(){}}class Lt extends et{constructor(){super(),this.gameStats={level:0,kills:0,armySize:0,wave:0,score:0},this.particleSystem=null,this.menuButton={x:0,y:0,width:280,height:70,text:"MENÃš PRINCIPAL",hovered:!1,scale:1,targetScale:1},this.fadeIn=0,this.titleShake=0,this.mouseX=0,this.mouseY=0,this.mouseMoveListener=null,this.mouseClickListener=null}enter(t={}){console.log("ðŸ’€ Game Over"),this.transitioning=!1,this.gameStats={level:t.level||0,kills:t.kills||0,armySize:t.armySize||0,wave:t.wave||0,score:this.calculateScore(t)},this.particleSystem=new it({maxParticles:300,enabled:!0}),this.menuButton.x=this.width/2-this.menuButton.width/2,this.menuButton.y=this.height-150,this.canvasBounds=this.canvas.getBoundingClientRect(),this.cacheGradients(),this.fadeIn=0,this.setupMouseListeners(),this.spawnDeathExplosion()}exit(){this.mouseMoveListener&&(this.canvas.removeEventListener("mousemove",this.mouseMoveListener),this.mouseMoveListener=null),this.mouseClickListener&&(this.canvas.removeEventListener("click",this.mouseClickListener),this.mouseClickListener=null),this.particleSystem&&(this.particleSystem.clear(),this.particleSystem=null),this.canvasBounds=null,this.backgroundGradient=null,this.titleGradient=null,this.buttonGradientNormal=null,this.buttonGradientHover=null}calculateScore(t){return(t.level||0)*100+(t.kills||0)*10+(t.armySize||0)*5+(t.wave||0)*50}setupMouseListeners(){this.mouseMoveListener=t=>{this.mouseX=t.clientX-this.canvasBounds.left,this.mouseY=t.clientY-this.canvasBounds.top,this.checkButtonHover()},this.mouseClickListener=t=>{const e=t.clientX-this.canvasBounds.left,s=t.clientY-this.canvasBounds.top;this.isPointInButton(e,s)&&this.returnToMenu()},this.canvas.addEventListener("mousemove",this.mouseMoveListener),this.canvas.addEventListener("click",this.mouseClickListener)}checkButtonHover(){const t=this.menuButton.hovered;this.menuButton.hovered=this.isPointInButton(this.mouseX,this.mouseY),this.menuButton.hovered!==t&&(this.menuButton.targetScale=this.menuButton.hovered?1.1:1,this.menuButton.hovered&&this.particleSystem.createExplosion(this.menuButton.x+this.menuButton.width/2,this.menuButton.y+this.menuButton.height/2,{count:8,color:"#ff6600",speed:80,size:3,lifetime:.6}))}isPointInButton(t,e){return t>=this.menuButton.x&&t<=this.menuButton.x+this.menuButton.width&&e>=this.menuButton.y&&e<=this.menuButton.y+this.menuButton.height}returnToMenu(){this.transitioning||(this.transitioning=!0,console.log("ðŸ”™ Volviendo al menÃº..."),this.particleSystem.createExplosion(this.menuButton.x+this.menuButton.width/2,this.menuButton.y+this.menuButton.height/2,{count:20,color:"#ff6600",speed:120,size:4}),setTimeout(()=>{this.sceneManager.switchTo("menu")},200))}spawnDeathExplosion(){for(let t=0;t<30;t++){const e=Math.PI*2*t/30,s=100+Math.random()*150,i=this.width/2,a=this.height/2-100,n=this.particleSystem.getParticle();n&&(n.init(i,a,Math.cos(e)*s,Math.sin(e)*s,3+Math.random()*4,Math.random()>.5?"#ff0000":"#ff6600",1.5,150),this.particleSystem.particles.push(n))}}update(t){this.fadeIn=Math.min(1,this.fadeIn+t*2),this.fadeIn<.5?this.titleShake=(Math.random()-.5)*10*(1-this.fadeIn*2):this.titleShake=0;const e=8;this.menuButton.scale+=(this.menuButton.targetScale-this.menuButton.scale)*e*t,this.particleSystem.update(t)}cacheGradients(){this.backgroundGradient=this.ctx.createRadialGradient(this.width/2,this.height/2,0,this.width/2,this.height/2,this.width),this.backgroundGradient.addColorStop(0,"#2a0a0a"),this.backgroundGradient.addColorStop(.5,"#1a0a0a"),this.backgroundGradient.addColorStop(1,"#0a0a0a"),this.titleGradient=this.ctx.createLinearGradient(this.width/2-300,0,this.width/2+300,0),this.titleGradient.addColorStop(0,"#ff6600"),this.titleGradient.addColorStop(.5,"#ff0000"),this.titleGradient.addColorStop(1,"#ff6600");const t=this.menuButton;this.buttonGradientNormal=this.ctx.createLinearGradient(t.x,t.y,t.x,t.y+t.height),this.buttonGradientNormal.addColorStop(0,"#cc5200"),this.buttonGradientNormal.addColorStop(1,"#993d00"),this.buttonGradientHover=this.ctx.createLinearGradient(t.x,t.y,t.x,t.y+t.height),this.buttonGradientHover.addColorStop(0,"#ff6600"),this.buttonGradientHover.addColorStop(1,"#cc5200")}render(){this.ctx.fillStyle=this.backgroundGradient,this.ctx.fillRect(0,0,this.width,this.height),this.particleSystem.render(this.ctx),this.ctx.fillStyle=`rgba(0, 0, 0, ${1-this.fadeIn})`,this.ctx.fillRect(0,0,this.width,this.height),this.renderGameOverTitle(),this.renderStats(),this.renderMenuButton()}renderGameOverTitle(){this.ctx.save(),this.ctx.textAlign="center";for(let t=3;t>0;t--)this.ctx.fillStyle=`rgba(255, 0, 0, ${.3/t})`,this.ctx.font="bold 100px serif",this.ctx.fillText("GAME OVER",this.width/2+this.titleShake+t*4,150+t*4);this.ctx.fillStyle=this.titleGradient,this.ctx.font="bold 100px serif",this.ctx.fillText("GAME OVER",this.width/2+this.titleShake,150),this.ctx.restore()}renderStats(){this.ctx.save(),this.ctx.textAlign="center";const t=280,e=50;this.ctx.fillStyle="#aaaaaa",this.ctx.font="bold 32px Arial",this.ctx.fillText("ESTADÃSTICAS FINALES",this.width/2,t),[{label:"Nivel Alcanzado",value:this.gameStats.level,color:"#bd00ff"},{label:"Oleada",value:this.gameStats.wave,color:"#ff6600"},{label:"TamaÃ±o del EjÃ©rcito",value:this.gameStats.armySize,color:"#00ffff"},{label:"PUNTUACIÃ“N TOTAL",value:this.gameStats.score,color:"#ffd700",bold:!0}].forEach((i,a)=>{const n=t+60+a*e;this.ctx.fillStyle="#888888",this.ctx.font=i.bold?"bold 28px Arial":"24px Arial",this.ctx.fillText(i.label,this.width/2-150,n),this.ctx.fillStyle=i.color,this.ctx.font=i.bold?"bold 32px Arial":"bold 28px Arial",this.ctx.fillText(i.value.toString(),this.width/2+150,n)}),this.ctx.restore()}renderMenuButton(){this.ctx.save();const t=this.menuButton,e=t.x+t.width/2,s=t.y+t.height/2;this.ctx.translate(e,s),this.ctx.scale(t.scale,t.scale),this.ctx.translate(-e,-s),t.hovered&&(this.ctx.shadowBlur=30,this.ctx.shadowColor="#ff6600");const i=t.hovered?this.buttonGradientHover:this.buttonGradientNormal;this.roundRect(t.x,t.y,t.width,t.height,10),this.ctx.fillStyle=i,this.ctx.fill(),this.ctx.strokeStyle=t.hovered?"#ffaa00":"#ff6600",this.ctx.lineWidth=t.hovered?3:2,this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.fillStyle="#ffffff",this.ctx.font="bold 28px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.text,e,s),this.ctx.restore()}roundRect(t,e,s,i,a){this.ctx.beginPath(),this.ctx.moveTo(t+a,e),this.ctx.lineTo(t+s-a,e),this.ctx.quadraticCurveTo(t+s,e,t+s,e+a),this.ctx.lineTo(t+s,e+i-a),this.ctx.quadraticCurveTo(t+s,e+i,t+s-a,e+i),this.ctx.lineTo(t+a,e+i),this.ctx.quadraticCurveTo(t,e+i,t,e+i-a),this.ctx.lineTo(t,e+a),this.ctx.quadraticCurveTo(t,e,t+a,e),this.ctx.closePath()}}function rt(){const m=document.getElementById("gameCanvas");if(!m){console.error("No se pudo encontrar el canvas");return}const t=new ut(m);t.registerScene("menu",new mt),t.registerScene("game",new Et),t.registerScene("gameover",new Lt),t.switchTo("menu"),t.start(),console.log("%cðŸŽ® Nigromante - El Invocador de las Sombras","color: #8b00ff; font-size: 20px; font-weight: bold;"),console.log("%cControles:","color: #00aaff; font-weight: bold;"),console.log("WASD - Movimiento"),console.log("ESPACIO - Atacar"),console.log("%cFase 5: MenÃº y Flujo de Juego implementado","color: #00ff00; font-weight: bold;"),console.log("%cDesarrollado con Vite + Canvas","color: #666; font-style: italic;"),window.sceneManager=t}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",rt):rt();
